<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Public Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/_public-landing.css">

    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <header class="public-header">
        <div class="logo">
            <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
        </div>
    </header>

    <main class="container-fluid py-4">
        <div class="container py-4">
            <div class="profile-layout">
                <div class="profile-sidebar">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <img id="publicProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile" class="avatar-img">
                        </div>
                        <div class="profile-details">
                            <h1 id="publicProfileName">Loading Name...</h1>
                            <div class="profile-meta">
                                <span id="publicProfileMajor"></span>
                                <span id="publicProfileDepartment"></span>
                                <span id="publicProfileBio"></span>
                            </div>
                            <div class="profile-stats">
                                <span><i class="fas fa-users"></i> <strong id="publicProfileFollowersCount">0</strong>&nbsp;Followers</span>
                                <span><i class="fas fa-user-plus"></i> <strong id="publicProfileFollowingCount">0</strong>&nbsp;Following</span>
                            </div>
                            <div class="social-links">
                                <a href="#" target="_blank" style="display:none;" id="publicGithubLink"><i class="fab fa-github"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicLinkedinLink"><i class="fab fa-linkedin"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicWebsiteLink"><i class="fas fa-globe"></i></a>
                            </div>
                            <div class="mt-3">
                                <a href="/signup.html" class="btn btn-primary w-100">Sign Up to Connect</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-content">
                    <div class="profile-section">
                        <h2 class="section-title">Projects</h2>
                        <hr class="section-divider">
                        <div class="project-grid" id="public-projects">
                            <p class="text-muted text-center">Loading projects...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // Local function to render a project card for this public page
        function renderProjectCard(project) {
            const cardHtml = `
                <div class="col">
                    <div class="card h-100" style="cursor: pointer;" onclick="window.location.href='/login.html?redirectedFrom=/project.html?id=${project.id || project._id}'">
                        <img src="${project.image || 'https://res.cloudinary.com/dphfedhek/image/upload/default-project.jpg'}" class="card-img-top" alt="${project.title}" onerror="this.src='https://res.cloudinary.com/dphfedhek/image/upload/default-project.jpg'">
                        <div class="card-body">
                            <h5 class="card-title">${project.title}</h5>
                            <p class="card-text">${project.description ? project.description.substring(0, 100) + '...' : 'No description'}</p>
                            <div class="project-meta">
                                <span class="project-author">By <a href="/public-landing-profile.html?userId=${project.userId}">${project.userName}</a></span>
                                <span class="project-views"><i class="fas fa-eye"></i> ${project.views || 0}</span>
                                <span class="project-likes"><i class="fas fa-heart"></i> ${project.likes || 0}</span>
                            </div>
                            <div class="project-tags">
                                ${(project.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return cardHtml;
        }

        async function loadPublicProfileDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');

            if (!userId) {
                Toastify({ text: 'No user ID provided.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                setTimeout(() => window.location.href = '/index.html', 3000); 
                return;
            }

            try {
                const userResponse = await fetch(`/user-details/${userId}`);
                if (!userResponse.ok) throw new Error('Failed to load public profile details.');
                const user = await userResponse.json();

                const projectsResponse = await fetch(`/projects-by-user/${userId}`);
                if (!projectsResponse.ok) throw new Error('Failed to load user projects.');
                const projects = await projectsResponse.json();

                document.getElementById('publicProfileName').textContent = user.name || 'N/A';
                document.getElementById('publicProfilePic').src = user.profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg';
                document.getElementById('publicProfileMajor').textContent = user.major || '';
                document.getElementById('publicProfileDepartment').textContent = user.department || '';
                document.getElementById('publicProfileBio').textContent = user.bio || '';
                document.getElementById('publicProfileFollowersCount').textContent = user.followersCount || 0;
                document.getElementById('publicProfileFollowingCount').textContent = user.followingCount || 0;

                const publicGithubLink = document.getElementById('publicGithubLink');
                const publicLinkedinLink = document.getElementById('publicLinkedinLink');
                const publicWebsiteLink = document.getElementById('publicWebsiteLink');

                if (user.socialLinks?.github && publicGithubLink) {
                    publicGithubLink.href = user.socialLinks.github;
                    publicGithubLink.style.display = 'inline-block';
                }
                if (user.socialLinks?.linkedin && publicLinkedinLink) {
                    publicLinkedinLink.href = user.socialLinks.linkedin;
                    publicLinkedinLink.style.display = 'inline-block';
                }
                if (user.socialLinks?.website && publicWebsiteLink) {
                    publicWebsiteLink.href = user.socialLinks.website;
                    publicWebsiteLink.style.display = 'inline-block';
                }

                const publicProjectsGrid = document.getElementById('public-projects');
                if (publicProjectsGrid) {
                    if (projects && projects.length > 0) {
                        publicProjectsGrid.innerHTML = projects.map(p => renderProjectCard(p)).join('');
                    } else {
                        publicProjectsGrid.innerHTML = '<p class="text-muted text-center">No public projects available.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading public profile or projects:', error);
                Toastify({
                    text: error.message || 'Error loading public profile.',
                    duration: 3000,
                    style: { background: '#e74c3c' },
                }).showToast();
                document.getElementById('public-projects').innerHTML = '<p class="text-muted text-center">Could not load projects.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPublicProfileDetails();
        });
    </script>
</body>
</html>