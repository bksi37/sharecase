<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture">
                <span id="headerProfileName">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    <main>
        <div class="container py-4">
            <h2 class="text-center mb-4">Admin Dashboard</h2>

            <div class="row row-cols-1 row-cols-md-4 g-4 mb-5" id="summaryMetrics">
                <p class="text-center w-100 text-muted">Loading core metrics...</p>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-lg-8">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">Project Analytics & Traffic</div>
                        <div class="card-body">
                            <div id="projectAnalytics" style="min-height: 300px;">
                                <p class="text-center text-muted">Loading project stats...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-success text-white">Meaningful Impact (ROI)</div>
                        <div class="card-body">
                            <h4 class="card-title text-success">Impact Metric (Placeholder)</h4>
                            <p class="card-text text-muted">
                                This metric quantifies project success based on trendlines (views/likes velocity).
                            </p>
                            <div id="impactChartContainer">
                                <canvas id="impactChart"></canvas>
                            </div>
                            <h5 class="mt-3" id="overallImpactScore">Score: N/A</h5>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4 mb-5">
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-info text-white">User Analytics (Roles)</div>
                        <div class="card-body">
                            <canvas id="userRoleChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-secondary text-white">Top Project Tags</div>
                        <div class="card-body">
                            <canvas id="topTagsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-7">
                    <div class="card p-4 shadow-lg">
                        <h3 class="mb-3">Point Allocation</h3>
                        <form id="pointAllocationForm">
                            <div class="mb-3">
                                <label for="userId" class="form-label">User ID</label>
                                <input type="text" class="form-control" id="userId" name="userId" required placeholder="Enter user's ID">
                                <small class="form-text text-muted">A user's ID can be found on their public profile URL.</small>
                            </div>
                            <div class="mb-3">
                                <label for="points" class="form-label">Points to Add</label>
                                <input type="number" class="form-control" id="points" name="points" required placeholder="e.g., 50">
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mt-3">Allocate Points</button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        <div class="row justify-content-center mb-5">
    <div class="col-md-8 col-lg-7">
        <div class="card p-4 shadow-lg rounded">
            <h3 class="mb-3">Send Custom Notification</h3>
            <form id="notificationForm">
                <div class="mb-3">
                    <label for="targetUserId" class="form-label">Recipient User ID</label>
                    <input type="text" class="form-control" id="targetUserId" name="targetUserId" required placeholder="Enter user's ID">
                </div>
                <div class="mb-3">
                    <label for="notificationMessage" class="form-label">Message</label>
                    <textarea class="form-control" id="notificationMessage" name="message" required placeholder="e.g., Your project received a featured badge!"></textarea>
                </div>
                <button type="submit" class="btn btn-warning w-100 mt-3">Send Notification</button>
            </form>
        </div>
    </div>
</div>
    </main>
    <footer>
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
    <script>
        // Global utility to render charts
        function renderChart(canvasId, type, data, options) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, { type, data, options });
        }

        async function loadAnalytics() {
            const summaryMetrics = document.getElementById('summaryMetrics');
            const projectAnalytics = document.getElementById('projectAnalytics');
            
            try {
                // 1. Fetch Core Dashboard Data (Total Users, Likes, etc.)
                const coreResponse = await fetch('/admin/dashboard-data', { credentials: 'include' });
                const coreData = await coreResponse.json();
                
                // 2. Fetch Project Analytics
                const projectResponse = await fetch('/admin/analytics/projects', { credentials: 'include' });
                const projectData = await projectResponse.json();

                // 3. Fetch User Analytics
                const userResponse = await fetch('/admin/users-analytics', { credentials: 'include' });
                const userData = await userResponse.json();

                if (!coreResponse.ok || !projectResponse.ok || !userResponse.ok) {
                    throw new Error(coreData.error || projectData.error || userData.error || 'Failed to load all analytics data.');
                }
                
                // --- A. Render Summary Metrics (for ROI/Overview) ---
                summaryMetrics.innerHTML = `
                    <div class="col">
                        <div class="card text-white bg-primary h-100 p-3">
                            <h5 class="card-title"><i class="fas fa-users me-2"></i> Total Users</h5>
                            <p class="card-text fs-2">${coreData.totalUsers}</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card text-white bg-warning h-100 p-3">
                            <h5 class="card-title"><i class="fas fa-layer-group me-2"></i> Total Projects</h5>
                            <p class="card-text fs-2">${coreData.totalPublishedProjects}</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card text-white bg-danger h-100 p-3">
                            <h5 class="card-title"><i class="fas fa-heart me-2"></i> Total Engagement (Likes)</h5>
                            <p class="card-text fs-2">${coreData.totalLikes}</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card text-white bg-success h-100 p-3">
                            <h5 class="card-title"><i class="fas fa-comment me-2"></i> Total Collaboration (Comments)</h5>
                            <p class="card-text fs-2">${coreData.totalComments}</p>
                        </div>
                    </div>
                `;

                // --- B. Render Project Analytics Table ---
                projectAnalytics.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">Projects by Type</h5>
                            <ul class="list-group list-group-flush small">
                                ${projectData.projectsByType.map(item => `<li class="list-group-item d-flex justify-content-between align-items-center">${item._id || 'Unspecified'}<span class="badge bg-primary rounded-pill">${item.count}</span></li>`).join('')}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">Top 5 Projects</h5>
                            <ol class="list-group list-group-numbered list-group-flush small">
                                ${projectData.topProjectsByViews.map(project => `<li class="list-group-item d-flex justify-content-between align-items-center"><a href="/project.html?id=${project._id}">${project.title}</a><span class="badge bg-secondary rounded-pill">${project.views} views</span></li>`).join('')}
                            </ol>
                            <h5 class="text-primary mt-3 mb-3">Top 10 Tags</h5>
                            <div id="topTagsList">
                                ${projectData.projectsByTag.map(tag => `<span class="badge bg-info me-1 mb-1">${tag._id} (${tag.count})</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // --- C. Render Charts ---

                // User Roles Chart
                renderChart('userRoleChart', 'pie', {
                    labels: userData.usersByRole.map(u => u._id),
                    datasets: [{
                        data: userData.usersByRole.map(u => u.count),
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#6c757d'],
                    }]
                }, { responsive: true, plugins: { legend: { position: 'right' } } });
                
                // Impact Chart (Placeholder)
                // NOTE: This chart currently uses dummy data to demonstrate the concept.
                renderChart('impactChart', 'line', {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Project Velocity Score',
                        data: [2, 5, 4, 8, 9, 12],
                        borderColor: 'rgba(40, 167, 69, 1)',
                        tension: 0.4,
                        fill: false
                    }]
                }, { responsive: true, plugins: { title: { display: true, text: 'Velocity Trend (Last 6 Months)' } } });
                
                document.getElementById('overallImpactScore').textContent = `Score: ${Math.round(Math.random() * 100)} (High Impact)`;

            } catch (error) {
                console.error('Error loading analytics:', error);
                summaryMetrics.innerHTML = `<p class="text-center text-danger w-100">Error: ${error.message}</p>`;
                projectAnalytics.innerHTML = '';
            }
        }
// admin-dashboard.html (Inside the main <script> block)

// --- Add this form handler logic ---

const notificationForm = document.getElementById('notificationForm');
if (notificationForm) {
    notificationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userId = document.getElementById('targetUserId').value;
        const message = document.getElementById('notificationMessage').value;

        try {
            const response = await fetch('/admin/send-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, message }),
                credentials: 'include'
            });

            const data = await response.json();
            
            if (response.ok && data.success) {
                Toastify({ text: data.message, duration: 3000, style: { background: '#28a745' } }).showToast();
                notificationForm.reset();
            } else {
                throw new Error(data.error || 'Failed to send notification.');
            }
        } catch (error) {
            console.error('Notification send error:', error);
            Toastify({ text: error.message || 'Error sending notification.', duration: 5000, style: { background: '#e74c3c' } }).showToast();
        }
    });
}
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure auth is loaded and user is admin (handled by server, but client loads header)
            loadUserProfileInHeader();

            // Point Allocation Form Logic (Remains the same)
            const pointAllocationForm = document.getElementById('pointAllocationForm');
            if (pointAllocationForm) {
                pointAllocationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const userId = document.getElementById('userId').value;
                    const points = document.getElementById('points').value;

                    try {
                        const response = await fetch('/admin/allocate-points', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({ userId, points: Number(points) }),
                            credentials: 'include'
                        });

                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            Toastify({ text: data.message, duration: 3000, style: { background: '#28a745' } }).showToast();
                            pointAllocationForm.reset();
                            loadAnalytics(); // Refresh analytics after successful allocation
                        } else {
                            throw new Error(data.error || 'Failed to allocate points.');
                        }
                    } catch (error) {
                        console.error('Point allocation error:', error);
                        Toastify({ text: error.message || 'An error occurred during point allocation.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    }
                });
            }

            // Load analytics data on page load
            loadAnalytics();
        });
    </script>
</body>
</html>