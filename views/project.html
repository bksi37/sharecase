<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Project Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_project_cards.css">
    <link rel="stylesheet" href="/css/_project_detail_page.css">
    <link rel="stylesheet" href="/css/_utilities.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="module" src="https://unpkg.com/@google/model-viewer@4.0.0/dist/model-viewer.min.js"></script>

    <style>
        .project-meta .list-unstyled {
            padding-left: 0; 
            margin-bottom: 1.5rem; 
            /* Added max-width to keep metadata readable if placed full-width */
            max-width: 500px; 
        }

        .project-meta .list-unstyled li {
            margin-bottom: 0.5rem; 
            line-height: 1.5;
        }

        .project-meta .list-unstyled li:last-child {
            display: flex;
            align-items: center;
            margin-top: 1rem; 
        }
        
        /* Ensure media container takes full width of the card's content area */
        #dynamicMediaContainer {
            width: 100%;
            margin-bottom: 2rem !important; /* Extra spacing after the large media element */
        }

        /* Styling for model-viewer for better full-width appearance */
        model-viewer {
            width: 100%;
            height: 500px; /* Give it a decent height */
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="dropdown">
                <button class="btn btn-outline-dark me-2" id="notificationButton" aria-label="Notifications" title="Notifications" data-bs-toggle="dropdown">
                    <i class="fas fa-bell"></i>
                    <span class="badge bg-danger" id="notificationCount" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 300px;">
                    <div class="dropdown-header">Notifications</div>
                    <div id="notificationList">
                        <div class="dropdown-item-text">No new notifications</div>
                    </div>
                </div>
            </div>
            <a href="/store-placeholder.html" class="btn btn-outline-dark me-3" id="storeButton" aria-label="Store" title="Store">
                <i class="fas fa-store"></i>
            </a>
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                <span id="headerProfileName" class="ms-2">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    <main class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-11">
                <div class="project-detail-card card p-4 shadow-sm mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 id="projectTitle" class="card-title mb-0">Loading Project...</h1>
                        <div id="editDeleteButtons" class="d-flex gap-2" style="display: none;">
                            <a id="editProjectBtn" class="btn btn-outline-secondary btn-sm" href="#"><i class="fas fa-edit me-1"></i> Edit</a>
                            <button id="deleteProjectBtn" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash-alt me-1"></i> Delete</button>
                        </div>
                    </div>

                    <div id="dynamicMediaContainer" class="mb-3">
                        <div class="text-muted">Loading media...</div>
                    </div>

                    <div class="project-details-section">
                        <div class="project-meta">
                            <ul class="list-unstyled">
                                <li><strong>By:</strong> <span id="projectAuthor"></span></li>
                                <li><strong>Type:</strong> <span id="projectType"></span></li>
                                <li><strong>Year:</strong> <span id="projectYear"></span></li>
                                <li><strong>Department:</strong> <span id="projectDepartment"></span></li>
                                <li><strong>Category:</strong> <span id="projectCategory"></span></li>
                                <li>
                                    <button id="likeButton" class="btn btn-outline-danger btn-sm"><i class="fas fa-heart"></i> Like</button>
                                    <span class="ms-3 text-muted small">
                                        <i class="fas fa-heart text-danger"></i> <span id="projectLikes"></span> 
                                        <i class="fas fa-eye ms-2"></i> <span id="projectViews"></span>
                                    </span>
                                </li>
                            </ul>
                        </div>
                        <div class="project-tags mb-3">
                            <strong>Tags:</strong>
                            <div id="projectTags"></div>
                        </div>
                        <div class="collaborators mb-3">
                            <strong>Collaborators:</strong>
                            <div id="collaboratorList"></div>
                        </div>
                        <div class="other-contributors mb-3">
                            <strong>Other Contributors:</strong>
                            <div id="otherContributors"></div>
                        </div>
                        <div class="resources mb-4">
                            <strong>Resources:</strong>
                            <div id="projectResources"></div>
                        </div>
                    </div>
                    <div class="project-description mb-3">
                        <h3>Description</h3>
                        <p id="projectDescription">Loading description...</p>
                    </div>
                    <div id="projectDetailsContainer" class="mb-3"></div>
                    <div class="problem-statement mb-3">
                        <h3>Problem Statement</h3>
                        <p id="problemStatement"></p>
                    </div>
                    <div class="comments-section">
                        <h3>Comments</h3>
                        <div id="commentsList" class="mb-3"></div>
                        <div id="commentFormContainer" style="display: none;">
                            <form id="commentForm">
                                <div class="mb-3">
                                    <textarea class="form-control" id="commentText" rows="4" placeholder="Add a comment..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Post Comment</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Filter Projects</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="courseFilter" class="form-label">Course</label>
                        <select id="courseFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="yearFilter" class="form-label">Year</label>
                        <select id="yearFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="typeFilter" class="form-label">Submission Type</label>
                        <select id="typeFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <select id="departmentFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select id="categoryFilter" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfileInHeader();
            loadProject();
            loadDynamicFilterOptions();

            const searchInput = document.getElementById('searchInput');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(window.searchTimeout);
                    window.searchTimeout = setTimeout(performGlobalSearch, window.DEBOUNCE_DELAY);
                });
            }

            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                    performGlobalSearch();
                    bootstrap.Modal.getInstance(document.getElementById('filterModal')).hide();
                });
            }
        });

        async function loadProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            console.log('Project ID from URL:', projectId);

            if (!projectId || projectId === 'undefined' || projectId.trim() === '') {
                console.warn('Invalid project ID:', projectId);
                document.getElementById('projectTitle').textContent = 'Invalid Project ID';
                document.getElementById('projectDescription').textContent = 'The project ID is invalid or missing. Please select a valid project from the homepage.';
                document.getElementById('dynamicMediaContainer').innerHTML = '<p class="text-muted">No project data available.</p>';
                Toastify({
                    text: 'No valid project ID provided. Please select a project from the homepage.',
                    duration: 5000,
                    style: { background: '#e74c3c' }
                }).showToast();
                return;
            }

            try {
                const response = await fetch(`/projects/project/${projectId}`, { credentials: 'include' });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                const project = await response.json();
                console.log('Project data:', project);

                // Update project details
                document.getElementById('projectTitle').textContent = project.title || 'Untitled';
                document.getElementById('projectDescription').textContent = project.description || 'No description available.';
                document.getElementById('projectAuthor').innerHTML = `<a href="/profile/${project.userId}">${project.userName || 'Unknown'}</a>`;
                document.getElementById('projectType').textContent = project.projectType || 'Other';
                document.getElementById('projectYear').textContent = project.year || 'N/A';
                document.getElementById('projectDepartment').textContent = project.department || 'N/A';
                document.getElementById('projectCategory').textContent = project.category || 'N/A';
                document.getElementById('projectViews').textContent = project.views || 0;
                document.getElementById('projectLikes').textContent = project.likes || 0;
                document.getElementById('problemStatement').textContent = project.problemStatement || 'No problem statement provided.';

                // Tags
                const projectTags = document.getElementById('projectTags');
                projectTags.innerHTML = project.tags?.length > 0
                    ? project.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
                    : '<span class="text-muted">No tags</span>';

                // Collaborators
                const collaboratorList = document.getElementById('collaboratorList');
                collaboratorList.innerHTML = project.collaborators?.length > 0
                    ? project.collaborators.map(c => `<a href="/profile/${c._id}">${c.name}</a>`).join(', ')
                    : '<span class="text-muted">None</span>';

                // Other Contributors
                const otherContributors = document.getElementById('otherContributors');
                otherContributors.innerHTML = project.otherContributors?.length > 0
                    ? project.otherContributors.join(', ')
                    : '<span class="text-muted">None</span>';

                // Resources
                const projectResources = document.getElementById('projectResources');
                projectResources.innerHTML = project.resources?.length > 0
                    ? project.resources.map(r => `<a href="${r}" target="_blank">${r}</a>`).join(', ')
                    : '<span class="text-muted">None</span>';

                // Media
                const dynamicMediaContainer = document.getElementById('dynamicMediaContainer');
                if (project.projectType === 'Engineering' && project.projectDetails?.CADFileLink) {
                    dynamicMediaContainer.innerHTML = `
                        <model-viewer src="${project.projectDetails.CADFileLink}" alt="${project.title}" camera-controls auto-rotate ar>
                            <button slot="ar-button" class="btn btn-primary">View in AR</button>
                        </model-viewer>`;
                } else if (project.projectType === 'Art' && project.projectDetails?.artworkImage) {
                    dynamicMediaContainer.innerHTML = `<img src="${project.projectDetails.artworkImage}" alt="${project.title}" class="img-fluid rounded">`;
                } else {
                    dynamicMediaContainer.innerHTML = `<img src="${project.image || 'https://res.cloudinary.com/dphfedhek/image/upload/default-project.jpg'}" alt="${project.title}" class="img-fluid rounded">`;
                }

                // Project Details
                const projectDetailsContainer = document.getElementById('projectDetailsContainer');
                if (project.projectType === 'Engineering') {
                    projectDetailsContainer.innerHTML = `
                        <h3>Technical Details</h3>
                        <p><strong>Technical Description:</strong> ${project.projectDetails.technicalDescription || 'N/A'}</p>
                        <p><strong>Tools/Software:</strong> ${project.projectDetails.toolsSoftware?.join(', ') || 'N/A'}</p>
                        <p><strong>Functional Goals:</strong> ${project.projectDetails.functionalGoals || 'N/A'}</p>
                    `;
                } else if (project.projectType === 'Art') {
                    projectDetailsContainer.innerHTML = `
                        <h3>Art Details</h3>
                        <p><strong>Medium/Technique:</strong> ${project.projectDetails.mediumTechnique || 'N/A'}</p>
                        <p><strong>Artist Statement:</strong> ${project.projectDetails.artistStatement || 'N/A'}</p>
                        <p><strong>Exhibition History:</strong> ${project.projectDetails.exhibitionHistory || 'N/A'}</p>
                    `;
                }

                // Like Button
                const likeButton = document.getElementById('likeButton');
                likeButton.innerHTML = project.likedBy.includes(currentLoggedInUserId)
                    ? '<i class="fas fa-heart"></i> Unlike'
                    : '<i class="fas fa-heart"></i> Like';
                likeButton.classList.toggle('btn-danger', project.likedBy.includes(currentLoggedInUserId));
                likeButton.classList.toggle('btn-outline-danger', !project.likedBy.includes(currentLoggedInUserId));
                likeButton.addEventListener('click', () => {
                    toggleLike(project.id, () => {
                        loadProject(); // Refresh project data
                    });
                });

                // Edit/Delete Buttons
                const editDeleteButtons = document.getElementById('editDeleteButtons');
                if (currentLoggedInUserId && (project.userId === currentLoggedInUserId || project.collaborators.some(c => c._id === currentLoggedInUserId))) {
                    editDeleteButtons.style.display = 'flex';
                    document.getElementById('editProjectBtn').href = `/edit-project.html?id=${project.id}`;
                    document.getElementById('deleteProjectBtn').addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this project?')) {
                            try {
                                const response = await fetch(`/projects/project/${project.id}`, {
                                    method: 'DELETE',
                                    credentials: 'include'
                                });
                                if (response.ok) {
                                    Toastify({
                                        text: 'Project deleted successfully!',
                                        duration: 3000,
                                        style: { background: '#28a745' }
                                    }).showToast();
                                    window.location.href = '/index.html';
                                } else {
                                    throw new Error('Failed to delete project');
                                }
                            } catch (error) {
                                console.error('Error deleting project:', error);
                                Toastify({
                                    text: 'Error deleting project.',
                                    duration: 3000,
                                    style: { background: '#e74c3c' }
                                }).showToast();
                            }
                        }
                    });
                }

                // Comments
                const commentFormContainer = document.getElementById('commentFormContainer');
                if (currentLoggedInUserId) {
                    commentFormContainer.style.display = 'block';
                    const commentForm = document.getElementById('commentForm');
                    commentForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const commentText = document.getElementById('commentText').value.trim();
                        if (!commentText) {
                            Toastify({
                                text: 'Comment cannot be empty.',
                                duration: 3000,
                                style: { background: '#e74c3c' }
                            }).showToast();
                            return;
                        }
                        try {
                            const response = await fetch(`/projects/project/${project.id}/comment`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ text: commentText })
                            });
                            if (response.ok) {
                                document.getElementById('commentText').value = '';
                                loadProject(); // Refresh comments
                            } else {
                                throw new Error('Failed to post comment');
                            }
                        } catch (error) {
                            console.error('Error posting comment:', error);
                            Toastify({
                                text: 'Error posting comment.',
                                duration: 3000,
                                style: { background: '#e74c3c' }
                            }).showToast();
                        }
                    });
                }

                const commentsList = document.getElementById('commentsList');
                commentsList.innerHTML = project.comments?.length > 0
                    ? project.comments.map(comment => `
                        <div class="comment mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="${comment.userProfilePic}" alt="${comment.userName}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                    <strong><a href="/profile/${comment.userId}">${comment.userName}</a></strong>
                                    <small class="text-muted ms-2">${new Date(comment.timestamp).toLocaleString()}</small>
                                </div>
                                ${currentLoggedInUserId && (comment.userId === currentLoggedInUserId || project.userId === currentLoggedInUserId) ? `
                                    <button class="btn btn-link text-danger btn-sm delete-comment-btn" data-comment-id="${comment._id}"><i class="fas fa-trash"></i></button>
                                ` : ''}
                            </div>
                            <p class="mb-0">${comment.text}</p>
                        </div>
                    `).join('')
                    : '<p class="text-muted">No comments yet.</p>';

                document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const commentId = btn.dataset.commentId;
                        if (await deleteComment(project.id, commentId)) {
                            loadProject(); // Refresh comments
                        }
                    });
                });

            } catch (error) {
                console.error('Error loading project:', error);
                document.getElementById('projectTitle').textContent = 'Error Loading Project';
                document.getElementById('projectDescription').textContent = 'An error occurred while loading the project. Please try again later or select a valid project from the homepage.';
                document.getElementById('dynamicMediaContainer').innerHTML = '<p class="text-muted">No project data available.</p>';
                Toastify({
                    text: error.message || 'Error loading project.',
                    duration: 5000,
                    style: { background: '#e74c3c' }
                }).showToast();
            }
        }
    </script>
</body>
</html>