<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Project Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_project_cards.css">
    <link rel="stylesheet" href="/css/_project_detail_page.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="module" src="https://unpkg.com/@google/model-viewer@4.0.0/dist/model-viewer.min.js"></script>

    <style>
        /* --- General Project Layout (Single Column) --- */
        .project-meta-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .project-meta-info {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .section-title {
            font-size: 1.6rem; 
            font-weight: 600;
            color: #212529;
            margin-top: 2.5rem; 
            margin-bottom: 1.5rem;
            border-bottom: none;
            padding-bottom: 0;
        }
        .content-text {
            white-space: pre-wrap; /* Preserve line breaks/formatting from textarea */
            line-height: 1.7;
            font-size: 1.05rem;
            color: #343a40;
        }

        /* --- Comment Styling Overrides for Consistency --- */
        /* Note: Using comment-item-custom to target the structure in this file */
        .comment-item-custom {
            display: flex;
            align-items: flex-start;
            padding: 15px 0;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
        }
        .comment-item-custom .author-info {
            line-height: 1.2;
        }
        .comment-item-custom .comment-text-body {
            color: #495057;
            margin-top: 5px;
            font-size: 0.95rem;
        }
        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        .comment-item-custom .btn-link {
            position: absolute;
            top: 10px;
            right: 0;
            padding: 0;
            opacity: 0.5;
        }
        .comment-item-custom:hover .btn-link {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="dropdown">
                <button class="btn btn-outline-dark me-2" id="notificationButton" aria-label="Notifications" title="Notifications" data-bs-toggle="dropdown">
                    <i class="fas fa-bell"></i>
                    <span class="badge bg-danger" id="notificationCount" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 300px;">
                    <div class="dropdown-header">Notifications</div>
                    <div id="notificationList">
                        <div class="dropdown-item-text">No new notifications</div>
                    </div>
                </div>
            </div>
            <a href="/store-placeholder.html" class="btn btn-outline-dark me-3" id="storeButton" aria-label="Store" title="Store">
                <i class="fas fa-store"></i>
            </a>
            <div class="profile-menu" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                <span id="headerProfileName" class="ms-2">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    
    <main class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-11">
                <div class="project-detail-card card p-4 shadow-sm mb-4">
                    
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h1 id="projectTitle" class="card-title mb-1">Loading Project...</h1>
                    </div>

                    <div class="project-meta-bar mb-4">
                        <div class="d-flex align-items-center">
                            <span class="text-muted me-3">By: <span id="projectAuthor" class="fw-bold">Loading...</span></span>
                            
                            <div class="project-engagement-icons d-flex gap-3 text-muted small">
                                <span><i class="fas fa-eye me-1"></i> <span id="projectViews">0</span></span>
                                <span class="text-danger"><i class="fas fa-heart me-1"></i> <span id="projectLikes">0</span></span>
                            </div>
                        </div>

                        <button id="likeButton" class="btn btn-outline-primary"><i class="fas fa-heart me-2"></i> Like </button>

                    </div>
                    
                    <div id="dynamicMediaContainer" class="mb-5">
                        <div class="text-muted text-center py-5">Loading media...</div>
                    </div>
                    
                    <div class="project-content-flow">
                        
                        <div id="projectTagsContainer" style="display: none;">
                            <h3 class="section-title">Tags</h3>
                            <div id="projectTags" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        
                        <div class="project-description">
                            <h3 class="section-title">Description</h3>
                            <p id="projectDescription" class="content-text">Loading description...</p>
                        </div>
                        
                        <div id="problemStatementContainer" style="display: none;">
                            <h3 class="section-title">Problem Statement</h3>
                            <p id="problemStatement" class="content-text"></p>
                        </div>

                        <div id="projectDetailsContainer" style="display: none;">
                            </div>

                        <div id="collaboratorInfoContainer" style="display: none;" class="mt-4">
                            <h3 class="section-title">Contributors & Resources</h3>
                            <div class="row g-3">
                                <div class="col-md-6" id="collaboratorListContainer" style="display: none;">
                                    <strong>Collaborators:</strong>
                                    <div id="collaboratorList" class="mt-1"></div>
                                </div>
                                <div class="col-md-6" id="otherContributorsContainer" style="display: none;">
                                    <strong>Other Contributors:</strong>
                                    <div id="otherContributors" class="mt-1"></div>
                                </div>
                                <div class="col-12 mt-3" id="resourcesContainer" style="display: none;">
                                    <strong>Resources:</strong>
                                    <div id="projectResources" class="mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="comments-section">
                        <div class="comments-header">
                            <h3 class="comments-title">Comments (<span id="commentCountDisplay">0</span>)</h3>
                            <button class="btn btn-outline-primary btn-sm" id="toggleCommentFormBtn">
                                <i class="fas fa-comment me-1"></i> Add Comment
                            </button>
                        </div>
                        
                        <div id="commentsList">
                            <p class="text-muted text-center py-3">No comments yet. Be the first!</p>
                        </div>
                        
                        <div id="commentFormContainer" style="display: none;">
                            <form id="commentForm">
                                <div class="mb-3">
                                    <textarea class="form-control" id="commentText" rows="3" placeholder="Share your feedback, questions, or appreciation..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                                <p id="commentLoginPrompt" class="text-danger small mt-2" style="display:none;">Please <a href="/login.html">login</a> to post a comment.</p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>

    <script>
        // Expose for scripts.js
        window.currentLoggedInUserId = null;
        window.deleteComment = deleteComment; // Expose globally for inline use

        document.addEventListener('DOMContentLoaded', async () => {
            // Load user profile first (handles visibility of auth/user-menu)
            await window.loadUserProfileInHeader(); 
            const userId = window.currentLoggedInUserId; 
            
            // Load project
            loadProject(userId);

            // Load filters (if defined elsewhere)
            if (typeof loadDynamicFilterOptions === 'function') {
                loadDynamicFilterOptions();
            }
        });

        // Toggle comment form
        document.getElementById('toggleCommentFormBtn')?.addEventListener('click', () => {
            const container = document.getElementById('commentFormContainer');
            const userId = window.currentLoggedInUserId;
            
            if (!userId) {
                // If not logged in, show prompt and hide form controls
                document.getElementById('commentLoginPrompt').style.display = 'block';
                document.getElementById('commentText').style.display = 'none';
                container.querySelector('button[type="submit"]').style.display = 'none';
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            } else {
                // Logged in user: show form
                document.getElementById('commentLoginPrompt').style.display = 'none';
                document.getElementById('commentText').style.display = 'block';
                container.querySelector('button[type="submit"]').style.display = 'block';
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
                if (container.style.display === 'block') {
                    document.getElementById('commentText').focus();
                }
            }
        });
        
        // --- Core Project Load Logic ---
        async function loadProject(userId) {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            if (!projectId) {
                document.getElementById('projectTitle').textContent = 'Invalid Project';
                return;
            }

            try {
                // Backend route is now public, credentials 'include' handles logged-in state
                const response = await fetch(`/projects/project/${projectId}`, { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to fetch project');
                const project = await response.json();

                // 1. Core Info
                document.getElementById('projectTitle').textContent = project.title;
                document.getElementById('projectAuthor').innerHTML = `<a href="/profile.html?id=${project.userId}" class="text-decoration-none text-dark">${project.userName}</a>`;
                document.getElementById('projectViews').textContent = project.views || 0;
                document.getElementById('projectLikes').textContent = project.likes || 0;
                
                // 2. Conditional Description & Problem Statement
                const desc = project.description || '';
                const problem = project.problemStatement || '';

                document.getElementById('projectDescription').textContent = desc || 'No description provided.';
                
                document.getElementById('problemStatementContainer').style.display = problem ? 'block' : 'none';
                document.getElementById('problemStatement').textContent = problem;


                // 3. Media
                const mediaContainer = document.getElementById('dynamicMediaContainer');
                let mediaHtml = '';

                if (project.projectType === 'Engineering' && project.projectDetails?.CADFileLink) {
                    mediaHtml = `<model-viewer src="${project.projectDetails.CADFileLink}" camera-controls auto-rotate shadow-intensity="1" style="width:100%; height:500px; border-radius:12px;"></model-viewer>`;
                } else if (project.projectType === 'Art' && project.projectDetails?.artworkImage) {
                    // Use object-fit: contain to ensure full image visibility without cropping
                    mediaHtml = `<img src="${project.projectDetails.artworkImage}" alt="${project.title}" class="img-fluid rounded" style="width:100%; max-height: 80vh; object-fit:contain; border-radius:12px;">`;
                } else {
                    // Fallback to main project image
                    mediaHtml = `<img src="${project.image || 'https://res.cloudinary.com/dphfedhek/image/upload/default-project.jpg'}" alt="${project.title}" class="img-fluid rounded" style="width:100%; max-height: 80vh; object-fit:contain; border-radius:12px;">`;
                }
                mediaContainer.innerHTML = mediaHtml;

                // 4. Conditional Dynamic Details
                const detailsContainer = document.getElementById('projectDetailsContainer');
                let detailsContent = '';

                // Engineering Details
                if (project.projectType === 'Engineering') {
                    const techDesc = project.projectDetails?.technicalDescription;
                    const tools = project.projectDetails?.toolsSoftware;
                    const goals = project.projectDetails?.functionalGoals;
                    if (techDesc || (tools && tools.length > 0) || goals) {
                         detailsContent = `
                            <h3 class="section-title">Technical Details</h3>
                            ${techDesc ? `<p><strong>Technical Description:</strong><br> <span class="content-text">${techDesc}</span></p>` : ''}
                            ${(tools && tools.length > 0) ? `<p><strong>Tools/Software:</strong> <span class="content-text">${tools.join(', ')}</span></p>` : ''}
                            ${goals ? `<p><strong>Functional Goals:</strong><br> <span class="content-text">${goals}</span></p>` : ''}
                        `;
                        detailsContainer.style.display = 'block';
                    } else {
                        detailsContainer.style.display = 'none';
                    }
                // Art Details
                } else if (project.projectType === 'Art') {
                    const medium = project.projectDetails?.mediumTechnique;
                    const statement = project.projectDetails?.artistStatement;
                    if (medium || statement) {
                        detailsContent = `
                            <h3 class="section-title">Artist Details</h3>
                            ${medium ? `<p><strong>Medium/Technique:</strong> <span class="content-text">${medium}</span></p>` : ''}
                            ${statement ? `<p><strong>Artist Statement:</strong><br> <span class="content-text">${statement}</span></p>` : ''}
                        `;
                        detailsContainer.style.display = 'block';
                    } else {
                        detailsContainer.style.display = 'none';
                    }
                } else {
                    detailsContainer.style.display = 'none';
                }
                detailsContainer.innerHTML = detailsContent;

                // 5. Conditional Info Block (Tags/Contributors/Resources)
                const tags = project.tags || [];
                const collaborators = project.collaborators || [];
                const otherContributors = project.otherContributors || '';
                const resources = project.resources || [];
                
                const hasContributors = collaborators.length > 0 || otherContributors;
                const hasResources = resources.length > 0;
                const hasTags = tags.length > 0;
                
                // Show/Hide Tags separately, located above other auxiliary info
                document.getElementById('projectTagsContainer').style.display = hasTags ? 'block' : 'none';
                document.getElementById('projectTags').innerHTML = tags
                    .map(tag => `<span class="tag badge bg-info me-1">${tag}</span>`).join('') || '';

                // Show/Hide Contributors/Resources section
                document.getElementById('collaboratorInfoContainer').style.display = hasContributors || hasResources ? 'block' : 'none';

                // Render Contributors
                document.getElementById('collaboratorListContainer').style.display = collaborators.length > 0 ? 'block' : 'none';
                document.getElementById('collaboratorList').innerHTML = collaborators
                    .map(c => `<a href="/profile.html?id=${c._id}" class="text-decoration-none">${c.name}</a>`).join(', ') || '';
                    
                document.getElementById('otherContributorsContainer').style.display = otherContributors ? 'block' : 'none';
                document.getElementById('otherContributors').textContent = otherContributors;

                // Render Resources
                document.getElementById('resourcesContainer').style.display = hasResources ? 'block' : 'none';
                document.getElementById('projectResources').innerHTML = resources
                    .map(r => `<a href="${r}" target="_blank" class="text-decoration-none small">${r.replace(/(^\w+:|^)\/\//, '').split('/').shift()}...</a>`).join(', ') || '';


                // 6. Like Button (Visible only if logged in)
                const likeBtn = document.getElementById('likeButton');
                const isLiked = project.likedBy?.includes(userId);
                
                if (userId) {
                    likeBtn.style.display = 'block';
                    likeBtn.innerHTML = isLiked 
                        ? '<i class="fas fa-heart me-2"></i> Liked'
                        : '<i class="fas fa-heart me-2"></i> Like';
                    likeBtn.className = isLiked ? 'btn btn-primary' : 'btn btn-outline-primary';
                    // Assuming toggleLike is available globally
                    likeBtn.onclick = () => toggleLike(project.id, userId, () => loadProject(userId));
                } else {
                    likeBtn.style.display = 'none';
                }

                // 7. Comments
                renderComments(project, userId, project.userId);
                bindCommentForm(project.id, userId);

            } catch (error) {
                console.error('Error loading project:', error);
                document.getElementById('projectTitle').textContent = 'Error Loading Project';
            }
        }

        // Render Comments (Function remains mostly the same, ensuring delete works)
        function renderComments(project, currentUserId, projectAuthorId) {
            const container = document.getElementById('commentsList');
            const countDisplay = document.getElementById('commentCountDisplay');
            const comments = project.comments || [];

            countDisplay.textContent = comments.length;
            if (comments.length === 0) {
                container.innerHTML = `<p class="text-muted text-center py-3">No comments yet. Be the first!</p>`;
                return;
            }

            container.innerHTML = comments.map(comment => {
                // Can delete if: Logged in AND (comment owner OR project owner)
                const canDelete = currentUserId && (comment.userId === currentUserId || projectAuthorId === currentUserId);
                return `
                    <div class="comment-item-custom d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-start flex-grow-1">
                            <img src="${comment.userProfilePic}" alt="${comment.userName}" class="rounded-circle me-3" style="width: 36px; height: 36px; object-fit: cover;">
                            <div class="author-info">
                                <strong><a href="/profile.html?id=${comment.userId}" class="text-decoration-none">${comment.userName}</a></strong>
                                <small class="text-muted ms-2">${new Date(comment.timestamp).toLocaleString()}</small>
                                <p class="mb-0 comment-text-body">${comment.text}</p>
                            </div>
                        </div>
                        ${canDelete ? `
                            <button class="btn btn-link text-danger btn-sm" onclick="deleteComment('${project.id}', '${comment._id}')" title="Delete">
                                <i class="fas fa-trash-alt fa-xs"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Delete Comment Function (Exposed globally)
        async function deleteComment(projectId, commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            const userId = window.currentLoggedInUserId;
            if (!userId) {
                Toastify({ text: 'You must be logged in to perform this action.', style: { background: '#ef4444' } }).showToast();
                return;
            }

            try {
                const res = await fetch(`/projects/project/${projectId}/comment/${commentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    Toastify({ text: 'Comment deleted.', style: { background: '#22c55e' } }).showToast();
                    loadProject(userId); // Reload to update comments list
                } else {
                    const err = await res.json().catch(() => ({}));
                    Toastify({ text: err.message || 'Failed to delete comment.', style: { background: '#ef4444' } }).showToast();
                }
            } catch (err) {
                Toastify({ text: 'Network error.', style: { background: '#ef4444' } }).showToast();
            }
        }

        // Bind Comment Form (once)
        function bindCommentForm(projectId, userId) {
            const form = document.getElementById('commentForm');
            if (!form) return;
            form.onsubmit = (e) => submitComment(e, projectId, userId);
        }

        // Submit Comment
        async function submitComment(e, projectId, userId) {
            e.preventDefault();
            if (!userId) {
                Toastify({ text: 'Please log in to comment', style: { background: '#ef4444' } }).showToast();
                return;
            }
            const text = document.getElementById('commentText').value.trim();
            if (!text) return;

            try {
                const res = await fetch(`/projects/project/${projectId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ text })
                });

                if (res.ok) {
                    document.getElementById('commentText').value = '';
                    document.getElementById('commentFormContainer').style.display = 'none';
                    loadProject(userId);
                } else {
                    const err = await res.json().catch(() => ({}));
                    Toastify({ text: err.message || 'Failed to post comment', style: { background: '#ef4444' } }).showToast();
                }
            } catch (err) {
                Toastify({ text: 'Network error', style: { background: '#ef4444' } }).showToast();
            }
        }
    </script>
</body>
</html>