<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Project Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_project_cards.css">
    <link rel="stylesheet" href="/css/_project_detail_page.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="module" src="https://unpkg.com/@google/model-viewer@4.0.0/dist/model-viewer.min.js"></script>

    <style>
        .project-meta-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #212529;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }
        .comment-item-custom {
            display: flex;
            align-items: flex-start;
            padding: 15px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .comment-item-custom .author-info {
            line-height: 1.2;
        }
        .comment-item-custom .comment-text-body {
            color: #495057;
            margin-top: 5px;
            font-size: 0.95rem;
        }
        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="dropdown">
                <button class="btn btn-outline-dark me-2" id="notificationButton" aria-label="Notifications" title="Notifications" data-bs-toggle="dropdown">
                    <i class="fas fa-bell"></i>
                    <span class="badge bg-danger" id="notificationCount" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 300px;">
                    <div class="dropdown-header">Notifications</div>
                    <div id="notificationList">
                        <div class="dropdown-item-text">No new notifications</div>
                    </div>
                </div>
            </div>
            <a href="/store-placeholder.html" class="btn btn-outline-dark me-3" id="storeButton" aria-label="Store" title="Store">
                <i class="fas fa-store"></i>
            </a>
            <div class="profile-menu" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                <span id="headerProfileName" class="ms-2">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    
    <main class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-11">
                <div class="project-detail-card card p-4 shadow-sm mb-4">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 id="projectTitle" class="card-title mb-0">Loading Project...</h1>
                    </div>

                    <div class="row project-media-section">
                        <div class="col-lg-8">
                            <div id="dynamicMediaContainer" class="mb-3">
                                <div class="text-muted text-center py-5">Loading media...</div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="project-meta-box">
                                <h5 class="fw-bold mb-3">Project Overview</h5>
                                <ul class="list-unstyled small">
                                    <li><strong>Author:</strong> <span id="projectAuthor">Loading...</span></li>
                                    <li><strong>Type:</strong> <span id="projectType">-</span></li>
                                    <li><strong>Year:</strong> <span id="projectYear">-</span></li>
                                    <li><strong>Department:</strong> <span id="projectDepartment">-</span></li>
                                    <li><strong>Category:</strong> <span id="projectCategory">-</span></li>
                                </ul>

                                <hr>
                                
                                <h5 class="fw-bold mb-3">Engagement</h5>
                                <button id="likeButton" class="btn btn-outline-primary mb-2 w-100"><i class="fas fa-heart me-2"></i> Like </button>
                                
                                <ul class="list-unstyled small mt-3">
                                    <li><i class="fas fa-heart text-danger me-2"></i> <strong>Likes:</strong> <strong id="projectLikes">0</strong></li>
                                    <li><i class="fas fa-eye me-2"></i> <strong>Views:</strong> <span id="projectViews">0</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">

                            <div class="project-description">
                                <h3 class="section-title">Description</h3>
                                <p id="projectDescription" class="content-text">Loading description...</p>
                            </div>

                            <div class="problem-statement">
                                <h3 class="section-title">Problem Statement</h3>
                                <p id="problemStatement" class="content-text">Loading...</p>
                            </div>

                            <div id="projectDetailsContainer" style="display: none;"></div>

                            <div class="project-info-block p-3 bg-light rounded mt-5">
                                <h3 class="section-title mb-3">Additional Info</h3>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <strong>Collaborators:</strong>
                                        <div id="collaboratorList" class="mt-1"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Other Contributors:</strong>
                                        <div id="otherContributors" class="mt-1"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tags:</strong>
                                        <div id="projectTags" class="mt-1"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Resources:</strong>
                                        <div id="projectResources" class="mt-1"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="comments-section">
                                <div class="comments-header">
                                    <h3 class="comments-title">Comments (<span id="commentCountDisplay">0</span>)</h3>
                                    <button class="btn btn-outline-primary btn-sm" id="toggleCommentFormBtn">
                                        <i class="fas fa-comment me-1"></i> Add Comment
                                    </button>
                                </div>
                                
                                <div id="commentsList">
                                    <p class="text-muted text-center py-3">No comments yet. Be the first!</p>
                                </div>
                                
                                <div id="commentFormContainer" style="display: none;">
                                    <form id="commentForm">
                                        <div class="mb-3">
                                            <textarea class="form-control" id="commentText" rows="3" placeholder="Share your feedback, questions, or appreciation..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>

    <!-- Main Project Logic -->
    <script>
        // Expose for scripts.js
        window.currentLoggedInUserId = null;

        // project.html (REVISED - Corrected)
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Load user profile first â†’ guarantees session & user ID
            // window.loadUserProfileInHeader() sets window.currentLoggedInUserId globally in scripts.js
            await window.loadUserProfileInHeader(); 
            
            // Get the ID that was globally set by loadUserProfileInHeader
            const userId = window.currentLoggedInUserId; 
            
            // 2. Load project
            loadProject(userId);

            // 3. Load filters (if on other pages)
            if (typeof loadDynamicFilterOptions === 'function') {
                loadDynamicFilterOptions();
            }
        });
        // Toggle comment form
        document.getElementById('toggleCommentFormBtn')?.addEventListener('click', () => {
            const container = document.getElementById('commentFormContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            if (container.style.display === 'block') {
                document.getElementById('commentText').focus();
            }
        });

        // Load Project
        async function loadProject(userId) {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            if (!projectId) {
                document.getElementById('projectTitle').textContent = 'Invalid Project';
                return;
            }

            try {
                const response = await fetch(`/projects/project/${projectId}`, { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to fetch project');
                const project = await response.json();

                // Basic Info
                document.getElementById('projectTitle').textContent = project.title;
                document.getElementById('projectAuthor').innerHTML = `<a href="/profile/${project.userId}" class="text-decoration-none">${project.userName}</a>`;
                document.getElementById('projectType').textContent = project.projectType || 'Other';
                document.getElementById('projectYear').textContent = project.year || 'N/A';
                document.getElementById('projectDepartment').textContent = project.department || 'N/A';
                document.getElementById('projectCategory').textContent = project.category || 'N/A';
                document.getElementById('projectLikes').textContent = project.likes || 0;
                document.getElementById('projectViews').textContent = project.views || 0;
                document.getElementById('projectDescription').textContent = project.description || 'No description.';
                document.getElementById('problemStatement').textContent = project.problemStatement || 'No problem statement.';

                // Media
                const mediaContainer = document.getElementById('dynamicMediaContainer');
                if (project.projectType === 'Engineering' && project.projectDetails?.CADFileLink) {
                    mediaContainer.innerHTML = `<model-viewer src="${project.projectDetails.CADFileLink}" camera-controls auto-rotate shadow-intensity="1" style="width:100%; height:500px; border-radius:12px;"></model-viewer>`;
                } else if (project.projectDetails?.artworkImage) {
                    mediaContainer.innerHTML = `<img src="${project.projectDetails.artworkImage}" alt="${project.title}" class="img-fluid rounded" style="width:100%; height:500px; object-fit:cover; border-radius:12px;">`;
                } else {
                    mediaContainer.innerHTML = `<img src="${project.image || 'https://res.cloudinary.com/dphfedhek/image/upload/default-project.jpg'}" alt="${project.title}" class="img-fluid rounded" style="width:100%; height:500px; object-fit:cover; border-radius:12px;">`;
                }

                // Dynamic Details
                const detailsContainer = document.getElementById('projectDetailsContainer');
                if (project.projectType === 'Engineering') {
                    detailsContainer.innerHTML = `
                        <h3 class="section-title">Technical Details</h3>
                        <p><strong>Technical Description:</strong> ${project.projectDetails?.technicalDescription || 'N/A'}</p>
                        <p><strong>Tools/Software:</strong> ${(project.projectDetails?.toolsSoftware || []).join(', ') || 'N/A'}</p>
                        <p><strong>Functional Goals:</strong> ${project.projectDetails?.functionalGoals || 'N/A'}</p>
                    `;
                    detailsContainer.style.display = 'block';
                } else if (project.projectType === 'Art') {
                    detailsContainer.innerHTML = `
                        <h3 class="section-title">Art Details</h3>
                        <p><strong>Medium/Technique:</strong> ${project.projectDetails?.mediumTechnique || 'N/A'}</p>
                        <p><strong>Artist Statement:</strong> ${project.projectDetails?.artistStatement || 'N/A'}</p>
                    `;
                    detailsContainer.style.display = 'block';
                } else {
                    detailsContainer.style.display = 'none';
                }

                // Like Button
                const likeBtn = document.getElementById('likeButton');
                const isLiked = project.likedBy?.includes(userId);
                likeBtn.innerHTML = isLiked 
                    ? '<i class="fas fa-heart me-2"></i> Liked' // Show solid heart when liked
                    : '<i class="fas fa-heart me-2"></i> Like'; // Show outline heart (or the default HTML) when unliked
                likeBtn.className = isLiked ? 'btn btn-primary mb-2 w-100' : 'btn btn-outline-primary mb-2 w-100';
                likeBtn.onclick = () => toggleLike(project.id, userId, () => loadProject(userId));
                // Info Block
                document.getElementById('projectTags').innerHTML = (project.tags || [])
                    .map(tag => `<span class="tag badge bg-info me-1">${tag}</span>`).join('') || '<span class="text-muted">No tags</span>';
                document.getElementById('collaboratorList').innerHTML = (project.collaborators || [])
                    .map(c => `<a href="/profile/${c._id}" class="text-decoration-none">${c.name}</a>`).join(', ') || 'None';
                document.getElementById('otherContributors').innerHTML = Array.isArray(project.otherContributors)
                    ? project.otherContributors.join(', ') : (project.otherContributors || 'None');
                document.getElementById('projectResources').innerHTML = (project.resources || [])
                    .map(r => `<a href="${r}" target="_blank" class="text-decoration-none small">${r.split('/').pop()}...</a>`).join(', ') || 'None';

                // Comments
                renderComments(project, userId, project.userId);
                bindCommentForm(project.id, userId);

            } catch (error) {
                console.error('Error loading project:', error);
                document.getElementById('projectTitle').textContent = 'Error Loading Project';
            }
        }

        // Render Comments
        function renderComments(project, currentUserId, projectAuthorId) {
            const container = document.getElementById('commentsList');
            const countDisplay = document.getElementById('commentCountDisplay');
            const comments = project.comments || [];

            countDisplay.textContent = comments.length;
            if (comments.length === 0) {
                container.innerHTML = `<p class="text-muted text-center py-3">No comments yet. Be the first!</p>`;
                return;
            }

            container.innerHTML = comments.map(comment => {
                const canDelete = currentUserId && (comment.userId === currentUserId || projectAuthorId === currentUserId);
                return `
                    <div class="comment-item-custom d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-start flex-grow-1">
                            <img src="${comment.userProfilePic}" alt="${comment.userName}" class="rounded-circle me-3" style="width: 36px; height: 36px; object-fit: cover;">
                            <div class="author-info">
                                <strong><a href="/profile/${comment.userId}" class="text-decoration-none">${comment.userName}</a></strong>
                                <small class="text-muted ms-2">${new Date(comment.timestamp).toLocaleString()}</small>
                                <p class="mb-0 comment-text-body">${comment.text}</p>
                            </div>
                        </div>
                        ${canDelete ? `
                            <button class="btn btn-link text-danger btn-sm p-0 ms-auto" onclick="deleteComment('${project.id}', '${comment._id}')" title="Delete">
                                <i class="fas fa-trash-alt fa-xs"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Bind Comment Form (once)
        function bindCommentForm(projectId, userId) {
            const form = document.getElementById('commentForm');
            if (!form) return;
            form.onsubmit = (e) => submitComment(e, projectId, userId);
        }

        // Submit Comment
        async function submitComment(e, projectId, userId) {
            e.preventDefault();
            if (!userId) {
                Toastify({ text: 'Please log in to comment', style: { background: '#ef4444' } }).showToast();
                return;
            }
            const text = document.getElementById('commentText').value.trim();
            if (!text) return;

            try {
                const res = await fetch(`/projects/project/${projectId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ text })
                });

                if (res.ok) {
                    document.getElementById('commentText').value = '';
                    document.getElementById('commentFormContainer').style.display = 'none';
                    loadProject(userId);
                } else {
                    const err = await res.json().catch(() => ({}));
                    Toastify({ text: err.message || 'Failed to post comment', style: { background: '#ef4444' } }).showToast();
                }
            } catch (err) {
                Toastify({ text: 'Network error', style: { background: '#ef4444' } }).showToast();
            }
        }
    </script>
</body>
</html>