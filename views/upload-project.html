<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Upload Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="module" src="https://unpkg.com/@google/model-viewer@4.0.0/dist/model-viewer.min.js"></script>

    <style>
        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        .notification-item.unread {
            background-color: #e6f7ff;
            font-weight: 500;
        }
        .notification-item .message {
            flex-grow: 1;
            padding-right: 10px;
        }
        .notification-item button {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .notification-item:hover button {
            opacity: 1;
        }
        /* Style for CAD Preview background */
        .cad-preview-area model-viewer {
            background-color: #6b6a6a; /* Light grey background for white models */
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="user-menu d-flex align-items-center">
            <a href="/store-placeholder.html" class="btn btn-outline-dark me-3" id="storeButton" aria-label="Store" title="Store">
                <i class="fas fa-store"></i>
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-dark me-2" id="notificationButton" aria-label="Notifications" title="Notifications" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bell"></i>
                    <span class="badge bg-danger" id="notificationCount" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 300px;">
                    <div class="dropdown-header">Notifications</div>
                    <div id="notificationList">
                        <div class="dropdown-item-text">No new notifications</div>
                    </div>
                </div>
            </div>
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                <span id="headerProfileName" class="ms-2">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="careerCenterDashboardLink" href="/admin/career-center-dashboard.html" class="dropdown-item" style="display: none;">Career Center Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>

    <main class="container-lg my-5 mx-auto"> 
        <div class="card p-4 shadow-sm">
            <h2 class="mb-4" id="uploadFormTitle">Upload a New Project</h2>
            <form id="uploadForm" enctype="multipart/form-data" aria-labelledby="uploadFormTitle">
                <div class="mb-3">
                    <label for="title" class="form-label">Project Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" required aria-required="true" placeholder="e.g., 3D Printed Drone">
                    <div class="invalid-feedback">Project Title is required.</div>
                </div>
                <div class="row mb-3 g-3">
                    <div class="col-md-6">
                        <label for="projectType" class="form-label">Project Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="projectType" name="projectType" required aria-required="true">
                            <option value="">Select Project Type</option>
                        </select>
                        <div class="invalid-feedback">Project Type is required to publish.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="">Select Year</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="description" name="description" rows="4" required aria-required="true" placeholder="A short, catchy summary (1-2 sentences)"></textarea>
                    <div class="invalid-feedback">Description is required to publish.</div>
                </div>
                <div class="mb-3">
                    <label for="problemStatement" class="form-label">Problem Statement</label>
                    <textarea class="form-control" id="problemStatement" name="problemStatement" rows="4" placeholder="What problem does your project solve?"></textarea>
                </div>
                
                <div id="CADFilePreview" class="mb-3 cad-preview-area" style="display: none;">
                    <h5 class="fw-bold">CAD Preview:</h5>
<model-viewer 
    alt="CAD model preview" 
    camera-controls 
    auto-rotate 
    shadow-intensity="1" 
    style="width: 100%; height: 300px;" 
    exposure="1.2"
    
    color="#007bff"    
    metallic="0.5"     
    roughness="0.5"    
    
    material-properties="apply-default-materials"
    
    camera-inertia="1.5"             camera-orbit-sensitivity="1.2"   ></model-viewer>
             </div>
                
                <div id="dynamic-fields-container" class="mb-3 p-3 border rounded bg-light">
                    <p class="text-muted mb-0">Specific fields (e.g., CAD File, Technical Description) will appear here after selecting a Project Type.</p>
                </div>
                
                <div class="mb-3">
                    <label for="image" class="form-label">Project Image <span class="text-danger">*</span></label>
                    <div class="dropzone p-3 border rounded text-center" id="imageDropzone" role="region" aria-label="Dropzone for project image">
                        <p class="mb-0">Drag & drop an image or click to select (JPEG, PNG, GIF, max 2MB)</p>
                        <input type="file" class="form-control d-none" id="image" name="image" accept="image/jpeg,image/png,image/gif" required aria-required="true">
                    </div>
                    <div id="imagePreview" class="mt-2" style="display: none;">
                        <img src="" alt="Image preview" class="rounded" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                    </div>
                    <div class="invalid-feedback">Project Image is required to publish.</div>
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">Tags <span class="text-danger">*</span></label>
                    <select class="form-select" id="tags" name="tags" multiple required aria-required="true">
                        <option value="" disabled>Select tags</option>
                    </select>
                    <small class="form-text text-muted">Select relevant tags (e.g., SolidWorks, Python). Hold Ctrl/Cmd to select multiple.</small>
                    <div class="invalid-feedback">At least one tag is required to publish.</div>
                </div>
                <div class="mb-3 position-relative">
                    <label class="form-label">Collaborators (Registered Users)</label>
                    <div class="form-control collaborator-input-container p-2" style="min-height: 50px;">
                        <div id="selectedCollaboratorsDisplay" class="d-flex flex-wrap gap-2 mb-2"></div>
                        <input type="text" id="collaboratorSearchInput" class="collaborator-search-input w-100 border-0" placeholder="Search by name or email..." aria-label="Search for collaborators">
                    </div>
                    <div id="collaboratorSearchResults" class="list-group position-absolute w-100 mt-1 shadow" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000;"></div>
                    <input type="hidden" id="collaboratorIds" name="collaboratorIds">
                </div>
                <div class="mb-3">
                    <label for="otherContributors" class="form-label">Other Contributors</label>
                    <input type="text" class="form-control" id="otherContributors" name="otherContributors" placeholder="e.g., Professor X, Guest Speaker">
                    <small class="form-text text-muted">For non-registered contributors (faculty, mentors).</small>
                </div>
                <div class="mb-3">
                    <label for="resources" class="form-label">Resources (comma-separated URLs)</label>
                    <input type="text" class="form-control" id="resources" name="resources" placeholder="e.g., https://github.com/user/repo">
                    <small class="form-text text-muted">Links to documentation, source code, or other files.</small>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="uploadProjectBtn">Publish Project</button>
                    <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save as Draft</button>
                    <button type="button" class="btn btn-outline-secondary" id="cancelUploadBtn">Cancel</button>
                </div>
                <small class="d-block mt-3 text-danger">Fields marked with (<span class="text-danger">*</span>) are required for publishing.</small>
            </form>
        </div>
    </main>
    <footer class="text-center py-3">
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
<script type="module">
    // Global Variables
    const DEBOUNCE_DELAY_SEARCH = 300;
    let debounceTimeout;
    let selectedCollaboratorIds = [];
    window.selectedCollaboratorIds = selectedCollaboratorIds;
    window.projectSchemas = { Default: [] }; 

    // DOM Elements
    const uploadForm = document.getElementById('uploadForm');
    const projectTypeSelect = document.getElementById('projectType');
    const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
    const collaboratorSearchInput = document.getElementById('collaboratorSearchInput');
    const collaboratorSearchResults = document.getElementById('collaboratorSearchResults');
    const selectedCollaboratorsDisplay = document.getElementById('selectedCollaboratorsDisplay');
    const collaboratorIdsHiddenInput = document.getElementById('collaboratorIds');
    const imageInput = document.getElementById('image');
    const imageDropzone = document.getElementById('imageDropzone');
    const imagePreview = document.getElementById('imagePreview');
    const tagsSelect = document.getElementById('tags'); 
    const CADFilePreview = document.getElementById('CADFilePreview'); // Added DOM element

    // --- File Handling Functions (Updated previewCADFile) ---
    
    function validateFileSize(input, maxSizeMB, fieldName) {
        if (input.files && input.files[0]) {
            const fileSizeMB = input.files[0].size / (1024 * 1024);
            if (fileSizeMB > maxSizeMB) {
                Toastify({ text: `${fieldName} exceeds ${maxSizeMB}MB limit.`, duration: 3000, style: { background: '#e74c3c' } }).showToast();
                input.value = '';
                const previewElement = document.getElementById(`${input.id}Preview`) || imagePreview;
                if (previewElement) previewElement.style.display = 'none';
                return false;
            }
            return true;
        }
        return true;
    }

    function previewImage(file, previewId) {
        const previewContainer = document.getElementById(previewId);
        const previewImg = previewContainer.querySelector('img');
        if (file && ['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
        }
    }

    function previewCADFile(file) {
        // Use the newly added CADFilePreview container
        if (!CADFilePreview) return;
        const modelViewer = CADFilePreview.querySelector('model-viewer');

        if (file && file.name.match(/\.(obj|stl|gltf|glb)$/i)) {
            const fileURL = URL.createObjectURL(file);
            modelViewer.src = fileURL;
            CADFilePreview.style.display = 'block';

            modelViewer.addEventListener('load', () => {
                setTimeout(() => URL.revokeObjectURL(fileURL), 5000);
            }, { once: true });

        } else {
            CADFilePreview.style.display = 'none';
            if (file && file.name.match(/\.step$/i)) {
                Toastify({
                    text: 'STEP files cannot be previewed in-browser. Use OBJ, GLTF, or STL.',
                    duration: 3000,
                    style: { background: '#e74c3c' }
                }).showToast();
            }
        }
    }

    function setupDropzone(dropzone, fileInput) {
        if (!dropzone || !fileInput) return;
        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('bg-light');
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('bg-light');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('bg-light');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // --- Core Dynamic Logic (Updated renderDynamicFields) ---
    
    async function loadProjectSchemas() {
        const endpoint = '/projects/dynamic-filter-options'; 
        try {
            const response = await fetch(endpoint, { credentials: 'include', headers: { 'Accept': 'application/json' } });
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            
            window.projectSchemas = data.projectSchemas || { Default: [] };

            window.populateDropdown(projectTypeSelect, data.types || ['Engineering', 'Art', 'Other'], 'Select Project Type');
            window.populateDropdown(document.getElementById('year'), data.years || [], 'Select Year');
            window.populateDropdown(document.getElementById('department'), data.departments || [], 'Select Department');
            window.populateDropdown(document.getElementById('category'), data.categories || [], 'Select Category');
            window.populateDropdown(tagsSelect, data.tools || [], 'Select tags'); 
            
        } catch (error) {
            console.error('Error loading filter options:', error);
            // Fallback schemas (Using your hardcoded data for robustness)
            window.projectSchemas = { 
                Default: [], 
                // Updated Engineering schema to include CADFile
                Engineering: [{ name: 'CADFile', label: 'CAD File', type: 'file', accept: '.gltf,.glb,.obj,.stl,.step', required: false, note: 'Upload STL, OBJ, GLTF, GLB, or STEP (max 10MB).' }, { name: 'technicalDescription', label: 'Technical Description', type: 'textarea', placeholder: 'Describe the technical aspects of your project.', required: true }, { name: 'toolsSoftware', label: 'Tools/Software Used', type: 'text', placeholder: 'e.g., SolidWorks, AutoCAD', required: true }, { name: 'functionalGoals', label: 'Functional Goals', type: 'textarea', placeholder: 'What are the functional objectives?', required: false }], 
                Art: [{ name: 'artworkImage', label: 'Artwork Image', type: 'file', accept: 'image/jpeg,image/png,image/gif', required: true, note: 'Upload JPEG, PNG, or GIF (max 2MB)' }, { name: 'mediumTechnique', label: 'Medium/Technique', type: 'text', placeholder: 'e.g., Oil on Canvas', required: true }, { name: 'artistStatement', label: 'Artist Statement', type: 'textarea', placeholder: 'Describe the concept behind your artwork.', required: true }, { name: 'exhibitionHistory', label: 'Exhibition History', type: 'text', placeholder: 'e.g., Exhibited at Art Fair 2023', required: false }]
            };
            window.populateDropdown(projectTypeSelect, ['Engineering', 'Art', 'Other'], 'Select Project Type');
            window.populateDropdown(document.getElementById('year'), ['2020', '2021', '2022', '2023', '2024', '2025'], 'Select Year');
            window.populateDropdown(document.getElementById('department'), ['Mechanical Engineering', 'Computer Science', 'Fine Arts'], 'Select Department');
            window.populateDropdown(document.getElementById('category'), ['Robotics', 'Software', 'Painting'], 'Select Category');
            window.populateDropdown(tagsSelect, ['SolidWorks', 'Python', 'AutoCAD', 'Photoshop'], 'Select tags');
        }
    }

    // Renders dynamic fields (CRUCIAL FUNCTION)
    function renderDynamicFields() {
        dynamicFieldsContainer.innerHTML = '';
        // Hide the main CAD preview area initially when dynamic fields change
        if (CADFilePreview) CADFilePreview.style.display = 'none'; 
        
        const selectedType = projectTypeSelect.value || 'Default';
        const schema = window.projectSchemas[selectedType] || window.projectSchemas.Default;
        
        if (schema.length === 0 && selectedType !== 'Default') {
             dynamicFieldsContainer.innerHTML = '<p class="text-muted mb-0">No specific fields required for this project type.</p>';
             return;
        } else if (selectedType === 'Default') {
             dynamicFieldsContainer.innerHTML = '<p class="text-muted mb-0">Specific fields (e.g., CAD File, Technical Description) will appear here after selecting a Project Type.</p>';
             return;
        }

        schema.forEach(field => {
            const fieldDiv = document.createElement('div');
            fieldDiv.classList.add('mb-3');
            const requiredAttr = field.required ? 'required aria-required="true"' : '';
            const maxSize = field.name === 'CADFile' ? '10MB' : '2MB';
            
            let htmlContent = '';
            
            if (field.type === 'file') {
                const isCAD = field.name === 'CADFile';
                
                htmlContent = `
                    <label for="${field.name}" class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                    <div class="dropzone p-3 border rounded text-center" id="${field.name}Dropzone" role="region" aria-label="Dropzone for ${field.label}">
                        <p class="mb-0">Drag & drop ${field.label} or click to select (${field.accept || 'Max 10MB'})</p>
                        <input type="file" class="form-control d-none" id="${field.name}" name="${field.name}" accept="${field.accept}" ${requiredAttr}>
                    </div>
                    ${field.name === 'artworkImage' ? `
                        <div id="${field.name}Preview" class="mt-2" style="display: none;">
                            <img src="" alt="${field.label} preview" class="rounded" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                        </div>
                    ` : ''}
                    `;
            } else if (field.type === 'textarea') {
                htmlContent = `
                    <label for="${field.name}" class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                    <textarea class="form-control" id="${field.name}" name="${field.name}" rows="4" placeholder="${field.placeholder}" ${requiredAttr}></textarea>`;
            } else {
                htmlContent = `
                    <label for="${field.name}" class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                    <input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" placeholder="${field.placeholder}" ${requiredAttr}>`;
            }

            htmlContent += field.note ? `<small class="form-text text-muted">${field.note}</small>` : '';
            htmlContent += `<div class="invalid-feedback">${field.label} is required.</div>`;

            fieldDiv.innerHTML = htmlContent;
            dynamicFieldsContainer.appendChild(fieldDiv);

            // --- ATTACH LISTENERS AFTER ELEMENTS EXIST ---
            if (field.type === 'file') {
                const dropzone = document.getElementById(`${field.name}Dropzone`);
                const fileInput = document.getElementById(field.name);
                const isCAD = field.name === 'CADFile';
                
                setupDropzone(dropzone, fileInput);
                
                fileInput.addEventListener('change', () => {
                    validateFileSize(fileInput, isCAD ? 10 : 2, field.label);
                    if (fileInput.files[0]) {
                        if (isCAD) {
                            previewCADFile(fileInput.files[0]);
                        } else if (field.name === 'artworkImage') {
                            previewImage(fileInput.files[0], `${field.name}Preview`);
                        }
                    }
                });
            }
        });
    }
    
    // --- Collaboration and Tags Functions (Logic remains the same) ---

    function updateCollaboratorIdsHiddenInput() { collaboratorIdsHiddenInput.value = selectedCollaboratorIds.join(','); }

    function addCollaboratorChip(userId, userName, profilePic) {
        if (!selectedCollaboratorIds.includes(userId)) {
            selectedCollaboratorIds.push(userId);
            const chip = document.createElement('div');
            chip.classList.add('collaborator-chip', 'd-flex', 'align-items-center', 'bg-light', 'border', 'rounded', 'px-2', 'py-1');
            chip.innerHTML = `
                <img src="${profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg'}" class="rounded-circle me-1" style="width: 24px; height: 24px; object-fit: cover;" alt="${userName}">
                <span>${userName}</span>
                <button type="button" class="btn-close btn-close-small ms-2" aria-label="Remove collaborator"></button>
            `;
            chip.querySelector('.btn-close').addEventListener('click', () => {
                selectedCollaboratorIds = selectedCollaboratorIds.filter(id => id !== userId);
                chip.remove();
                updateCollaboratorIdsHiddenInput();
            });
            selectedCollaboratorsDisplay.appendChild(chip);
            updateCollaboratorIdsHiddenInput();
            collaboratorSearchInput.value = '';
            collaboratorSearchResults.style.display = 'none';
        }
    }

    // --- Validation and Submission ---
    
    function validateForm(isPublishing) {
        let isValid = true;
        uploadForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        
        const requiredFields = isPublishing ? ['title', 'projectType', 'description'] : ['title'];
        requiredFields.forEach(id => {
            const input = document.getElementById(id);
            if (input && !input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        if (isPublishing) {
            // Validate Image/File Inputs
            if (!imageInput.files[0]) { imageInput.classList.add('is-invalid'); isValid = false; }

            // Validate Tags (check if any options in the SELECT dropdown are selected)
            const tags = Array.from(tagsSelect.selectedOptions).map(option => option.value);
            const coreTags = [document.getElementById('year').value, document.getElementById('department').value, document.getElementById('category').value].filter(t => t);
            if (tags.length === 0 && coreTags.length === 0) { 
                tagsSelect.classList.add('is-invalid'); 
                Toastify({ text: 'At least one tag is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast(); 
                isValid = false; 
            } else {
                tagsSelect.classList.remove('is-invalid');
            }
            
            // Validate dynamic schema required fields
            const schema = window.projectSchemas[projectTypeSelect.value] || window.projectSchemas.Default;
            schema.forEach(field => {
                if (field.required) {
                    const input = document.getElementById(field.name);
                    if (input && (!input.value.trim() || (input.type === 'file' && !input.files[0]))) { 
                        input.classList.add('is-invalid'); 
                        isValid = false; 
                    }
                }
            });
        }
        if (!isValid) { Toastify({ text: 'Please fill out all required fields.', duration: 3000, style: { background: '#e74c3c' } }).showToast(); }
        return isValid;
    }

    async function submitProject(isPublished) {
        if (!validateForm(isPublished)) return;
        
        const formData = new FormData(uploadForm);
        formData.append('isPublished', isPublished);
        
        const selectedTags = Array.from(tagsSelect.selectedOptions).map(option => option.value);
        const coreTags = [document.getElementById('year').value, document.getElementById('department').value, document.getElementById('category').value].filter(t => t);
        
        formData.delete('tags'); 
        formData.append('tags', [...new Set([...selectedTags, ...coreTags])].join(','));


        try {
            const response = await fetch('/projects/add-project', { method: 'POST', body: formData, credentials: 'include' });
            const data = await response.json();
            
            if (response.ok) {
                Toastify({ text: data.message, duration: 3000, style: { background: '#28a745' } }).showToast();
                uploadForm.reset();
                selectedCollaboratorIds = [];
                // Reset UI
                selectedCollaboratorsDisplay.innerHTML = '';
                imagePreview.style.display = 'none';
                dynamicFieldsContainer.innerHTML = '<p class="text-muted mb-0">Specific fields (e.g., CAD File, Technical Description) will appear here after selecting a Project Type.</p>';
                setTimeout(() => window.location.href = data.redirect, 3000);
            } else {
                const errorMsg = data.error || data.details || 'Failed to process project.';
                Toastify({ text: errorMsg, duration: 5000, style: { background: '#e74c3c' } }).showToast();
            }
        } catch (error) {
            console.error('Error submitting project:', error);
            Toastify({ text: 'A network error occurred during upload.', duration: 5000, style: { background: '#e74c3c' } }).showToast();
        }
    }

    // --- Main Initialization Function (Exposed Globally) ---

    async function initializeForm() {
        await loadProjectSchemas();
        await window.loadUserProfileInHeader();
        renderDynamicFields();
    }
    window.initializeForm = initializeForm;

    // --- Event Listeners ---

    document.addEventListener('DOMContentLoaded', () => {
        initializeForm().then(() => {
            // Attach main event listeners after schemas are loaded and initialized
            projectTypeSelect.addEventListener('change', renderDynamicFields);
            
            // Static image upload listener
            imageInput.addEventListener('change', () => {
                validateFileSize(imageInput, 2, 'Project Image');
                previewImage(imageInput.files[0], 'imagePreview');
            });
            setupDropzone(imageDropzone, imageInput);

            // Collaborator Search Listener (using external searchUsers)
            collaboratorSearchInput.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    const query = collaboratorSearchInput.value.trim();
                    if (query) {
                        window.searchUsers(query, collaboratorSearchResults, addCollaboratorChip, selectedCollaboratorIds);
                    } else {
                        collaboratorSearchResults.style.display = 'none';
                    }
                }, DEBOUNCE_DELAY_SEARCH);
            });
            
            // Submission Listeners
            document.getElementById('uploadProjectBtn').addEventListener('click', (e) => { e.preventDefault(); submitProject(true); });
            document.getElementById('saveDraftBtn').addEventListener('click', (e) => { e.preventDefault(); submitProject(false); });
            document.getElementById('cancelUploadBtn').addEventListener('click', () => {
                uploadForm.reset();
                selectedCollaboratorIds = [];
                selectedCollaboratorsDisplay.innerHTML = '';
                imagePreview.style.display = 'none';
                dynamicFieldsContainer.innerHTML = '<p class="text-muted mb-0">Specific fields (e.g., CAD File, Technical Description) will appear here after selecting a Project Type.</p>';
                Toastify({ text: 'Upload cancelled', duration: 2000, style: { background: '#6c757d' } }).showToast();
            });
            
            // Initialize notification button listener
            const notificationButton = document.getElementById('notificationButton');
            if (notificationButton) {
                notificationButton.addEventListener('shown.bs.dropdown', () => {
                    window.fetchNotifications(); // Assuming fetchNotifications is global in scripts.js
                });
                window.deleteNotification = window.deleteNotification || function() {}; // Ensure exists
            }
        });
    });
</script>
</body>
</html>