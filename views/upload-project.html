<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Upload Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css"> 
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="user-menu d-flex align-items-center">
            <button class="btn btn-outline-dark me-2" id="notificationButton" aria-label="Notifications" title="Notifications Placeholder">
                <i class="fas fa-bell"></i>
            </button>
            <a href="/store-placeholder.html" class="btn btn-outline-dark me-3" id="storeButton" aria-label="Store" title="Store Placeholder">
                <i class="fas fa-store"></i>
            </a>
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture">
                <span id="headerProfileName">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin-dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="upload-container card p-4 shadow-sm my-4">
                <h2>Upload a New Project</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Project Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="row mb-3 g-3">
                        <div class="col-md-6">
                            <label for="projectType" class="form-label">Project Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="projectType" name="projectType" required>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" name="department">
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="year" class="form-label">Year/Graduation</label>
                            <select class="form-select" id="year" name="year">
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Short Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="A short, catchy summary (1-2 sentences)..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="problemStatement" class="form-label">Problem Statement</label>
                        <textarea class="form-control" id="problemStatement" name="problemStatement" rows="4" placeholder="What problem does your project solve?"></textarea>
                    </div>
                    <div id="dynamic-fields-container"></div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Additional Tags (Comma-separated tools, courses, themes)</label>
                        <input type="text" class="form-control" id="tags" name="tags" placeholder="e.g., Python, SolidWorks, ENGR 101, Sustainability">
                        <small class="form-text text-muted">Use tags to make your project searchable by tool, course code, or theme.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Collaborators (Registered Users)</label>
                        <div class="form-control collaborator-input-container">
                            <div id="selectedCollaboratorsDisplay" class="d-flex flex-wrap align-items-center gap-2"></div>
                            <input type="text" id="collaboratorSearchInput" class="form-control flex-grow-1" placeholder="Search by name or email..." style="border: none; outline: none; box-shadow: none; padding: 0; min-width: 150px;">
                        </div>
                        <div id="collaboratorSearchResults" class="list-group position-absolute z-index-1000 w-100 mt-1 shadow" style="max-height: 200px; overflow-y: auto; display: none; background-color: white;"></div>
                        <input type="hidden" id="collaboratorIds" name="collaboratorIds">
                    </div>
                    <div class="mb-3">
                        <label for="otherContributors" class="form-label">Other Contributors (Faculty, Mentors, comma-separated)</label>
                        <input type="text" class="form-control" id="otherContributors" name="otherContributors" placeholder="Guest Speaker, Professor X, External Advisor">
                        <small class="form-text text-muted">For individuals not registered on ShareCase.</small>
                    </div>
                    <div class="mb-3">
                        <label for="resources" class="form-label">Resources (comma-separated URLs)</label>
                        <input type="text" class="form-control" id="resources" name="resources" placeholder="e.g., http://example.com/doc.pdf, https://github.com/user/repo">
                        <small class="form-text text-muted">Provide links to project files, external documentation, or source code.</small>
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">Project Image <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/jpeg,image/png,image/gif" required>
                        <small class="form-text text-muted">Max 2MB. Supported formats: JPEG, PNG, GIF.</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="uploadProjectBtn">Publish Project</button>
                        <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save as Draft</button>
                        <button type="button" class="btn btn-outline-secondary" id="cancelUploadBtn">Cancel</button>
                    </div>
                    <small class="d-block mt-3 text-danger">Fields marked with (<span class="text-danger">*</span>) are required for <strong>Publishing</strong>.</small>
                </form>
            </div>
        </div>
    </main>
    <footer>
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
 <script>
// --- Local Variables ---
const DEBOUNCE_DELAY_SEARCH = 300; // ms for search input
let debounceTimeout;

// --- Global elements and variables exposed to window for scripts.js functions ---
const collaboratorSearchInput = document.getElementById('collaboratorSearchInput');
const collaboratorSearchResults = document.getElementById('collaboratorSearchResults');
const selectedCollaboratorsDisplay = document.getElementById('selectedCollaboratorsDisplay');
const collaboratorIdsHiddenInput = document.getElementById('collaboratorIds');
let selectedCollaboratorIds = [];
window.selectedCollaboratorIds = selectedCollaboratorIds; // Expose to window object

// --- Collaborator Search and Selection Logic ---
function updateCollaboratorIdsHiddenInput() {
    if (collaboratorIdsHiddenInput) {
        collaboratorIdsHiddenInput.value = window.selectedCollaboratorIds.join(',');
    }
}

function addCollaboratorChip(userId, userName, profilePic) {
    if (!selectedCollaboratorIds.includes(userId)) {
        selectedCollaboratorIds.push(userId);
        const chip = document.createElement('div');
        chip.classList.add('collaborator-chip', 'd-flex', 'align-items-center', 'bg-light', 'border', 'rounded', 'px-2', 'py-1');
        chip.innerHTML = `
            <img src="${profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg'}" class="rounded-circle me-1" style="width: 24px; height: 24px; object-fit: cover;" alt="${userName}">
            <span>${userName}</span>
            <button type="button" class="btn-close btn-close-small ms-2" aria-label="Remove collaborator"></button>
        `;
        chip.querySelector('.btn-close').addEventListener('click', () => {
            selectedCollaboratorIds = selectedCollaboratorIds.filter(id => id !== userId);
            chip.remove();
            updateCollaboratorIdsHiddenInput();
        });
        selectedCollaboratorsDisplay.appendChild(chip);
        updateCollaboratorIdsHiddenInput();
        collaboratorSearchInput.value = '';
        collaboratorSearchResults.style.display = 'none';
    }
}

if (collaboratorSearchInput && collaboratorSearchResults) {
    collaboratorSearchInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const query = collaboratorSearchInput.value.trim();
            window.searchUsers(query, collaboratorSearchResults, addCollaboratorChip, selectedCollaboratorIds);
        }, DEBOUNCE_DELAY_SEARCH);
    });
}

// --- Dynamic Form Rendering ---
const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
const projectTypeSelect = document.getElementById('projectType');

async function loadProjectSchemas() {
    try {
        const response = await fetch('/dynamic-filter-options');
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Dynamic filter options response:', JSON.stringify(data, null, 2)); // Debug log
        window.projectSchemas = data.projectSchemas || { Default: [] };

        if (projectTypeSelect) {
            window.populateDropdown(projectTypeSelect, data.types || [], 'Select Project Type');
            projectTypeSelect.addEventListener('change', renderDynamicFields);
        }

        // Handle tags placeholder safely
        const tagsInput = document.getElementById('tags');
        if (tagsInput) {
            tagsInput.placeholder = data.toolsThemes && Array.isArray(data.toolsThemes) && data.toolsThemes.length > 0
                ? `e.g., ${data.toolsThemes.slice(0, 3).join(', ')}`
                : 'e.g., Python, SolidWorks, Sustainability';
        }

        window.populateDropdown(document.getElementById('year'), data.years || [], 'Select Year');
        window.populateDropdown(document.getElementById('department'), data.departments || [], 'Select Department');
        window.populateDropdown(document.getElementById('category'), data.categories || [], 'Select Category');
    } catch (error) {
        console.error('Error loading project schemas:', error);
        Toastify({ text: 'Error loading project options. Please try again.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
        // Fallback: Populate dropdowns with defaults
        if (projectTypeSelect) {
            window.populateDropdown(projectTypeSelect, ['Engineering', 'Art', 'Other'], 'Select Project Type');
            projectTypeSelect.addEventListener('change', renderDynamicFields);
        }
        window.populateDropdown(document.getElementById('year'), [], 'Select Year');
        window.populateDropdown(document.getElementById('department'), [], 'Select Department');
        window.populateDropdown(document.getElementById('category'), [], 'Select Category');
    }
}

function renderDynamicFields() {
    const selectedType = projectTypeSelect.value;
    dynamicFieldsContainer.innerHTML = '';
    if (!window.projectSchemas || !selectedType) return;
    const schema = window.projectSchemas[selectedType] || window.projectSchemas['Default'] || [];
    schema.forEach(field => {
        let inputHtml = '';
        const requiredIndicator = field.required ? '<span class="text-danger">*</span>' : '';
        if (field.type === 'textarea') {
            inputHtml = `<textarea class="form-control" id="${field.name}" name="${field.name}" rows="4" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}></textarea>`;
        } else if (field.type === 'text') {
            inputHtml = `<input type="text" class="form-control" id="${field.name}" name="${field.name}" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'file') {
            inputHtml = `<input type="file" class="form-control" id="${field.name}" name="${field.name}" accept="${field.accept}" ${field.required ? 'required' : ''}>`;
        }
        const fieldDiv = document.createElement('div');
        fieldDiv.classList.add('mb-3');
        fieldDiv.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label} ${requiredIndicator}</label>
            ${inputHtml}
            ${field.note ? `<small class="form-text text-muted">${field.note}</small>` : ''}
        `;
        dynamicFieldsContainer.appendChild(fieldDiv);
    });
}

// --- File Size Validation ---
const imageInput = document.getElementById('image');
function validateFileSize(input, maxSizeMB, fieldName) {
    if (input.files && input.files[0]) {
        const fileSizeMB = input.files[0].size / (1024 * 1024);
        if (fileSizeMB > maxSizeMB) {
            Toastify({ text: `${fieldName} exceeds ${maxSizeMB}MB limit.`, duration: 3000, style: { background: '#e74c3c' } }).showToast();
            input.value = '';
            return false;
        }
        return true;
    }
    return true;
}

if (imageInput) {
    imageInput.addEventListener('change', () => {
        validateFileSize(imageInput, 2, 'Project Image');
    });
}

// --- Form Submission Logic ---
document.addEventListener('DOMContentLoaded', () => {
    const uploadForm = document.getElementById('uploadForm');
    const uploadProjectBtn = document.getElementById('uploadProjectBtn');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');

    if (uploadForm && uploadProjectBtn && saveDraftBtn) {
        uploadProjectBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!validateForm(true)) return;
            await submitProject(true); // Publish
        });

        saveDraftBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!document.getElementById('title').value.trim()) {
                Toastify({ text: 'Project Title is required to save as draft.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                return;
            }
            await submitProject(false); // Draft
        });

        function validateForm(isPublishing) {
            if (!document.getElementById('title').value.trim()) {
                Toastify({ text: 'Project Title is required.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                return false;
            }
            if (isPublishing) {
                if (!projectTypeSelect.value) {
                    Toastify({ text: 'Project Type is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    return false;
                }
                if (!document.getElementById('description').value.trim()) {
                    Toastify({ text: 'Description is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    return false;
                }
                if (!imageInput.files[0]) {
                    Toastify({ text: 'Project Image is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    return false;
                }
                if (!validateFileSize(imageInput, 2, 'Project Image')) return false;
                const selectedTags = document.getElementById('tags').value.split(',').filter(t => t.trim()).length;
                const coreTags = [document.getElementById('year').value, document.getElementById('department').value, document.getElementById('category').value].filter(t => t).length;
                if (selectedTags === 0 && coreTags === 0) {
                    Toastify({ text: 'At least one tag (General or Core) is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    return false;
                }
                if (!validateDynamicFields()) {
                    Toastify({ text: 'Please fill out all required fields for the selected Project Type.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    return false;
                }
            }
            return true;
        }

        function validateDynamicFields() {
            const currentSchema = window.projectSchemas[projectTypeSelect.value] || [];
            let isValid = true;
            currentSchema.forEach(field => {
                if (field.required) {
                    const input = document.getElementById(field.name);
                    if (input) {
                        if (input.type === 'file' && !input.files[0]) {
                            isValid = false;
                        } else if (input.type !== 'file' && !input.value.trim()) {
                            isValid = false;
                        }
                        if (field.name === 'CADFile' && input.files[0] && !validateFileSize(input, 10, 'CAD File')) {
                            isValid = false;
                        }
                    }
                }
            });
            return isValid;
        }

        async function submitProject(isPublishedStatus) {
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value.trim());
            formData.append('projectType', projectTypeSelect.value || 'Other');
            formData.append('description', document.getElementById('description').value);
            formData.append('problemStatement', document.getElementById('problemStatement').value);
            formData.append('year', document.getElementById('year').value);
            formData.append('department', document.getElementById('department').value);
            formData.append('category', document.getElementById('category').value);
            const generalTags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
            const coreTags = [document.getElementById('year').value, document.getElementById('department').value, document.getElementById('category').value].filter(t => t);
            const uniqueTags = [...new Set([...generalTags, ...coreTags])];
            formData.append('tags', uniqueTags.join(','));
            formData.append('collaboratorIds', collaboratorIdsHiddenInput.value);
            formData.append('otherContributors', document.getElementById('otherContributors').value);
            formData.append('resources', document.getElementById('resources').value);
            formData.append('isPublished', isPublishedStatus ? 'true' : 'false');
            if (imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }
            const currentSchema = window.projectSchemas[projectTypeSelect.value] || [];
            currentSchema.forEach(field => {
                const input = document.getElementById(field.name);
                if (input) {
                    if (input.type === 'file' && input.files[0]) {
                        formData.append(field.name, input.files[0]);
                    } else {
                        formData.append(field.name, input.value);
                    }
                }
            });

            try {
                const response = await fetch('/projects/add-project', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    Toastify({ text: data.message, duration: 3000, style: { background: '#28a745' } }).showToast();
                    uploadForm.reset();
                    selectedCollaboratorIds = [];
                    selectedCollaboratorsDisplay.innerHTML = '';
                    updateCollaboratorIdsHiddenInput();
                    dynamicFieldsContainer.innerHTML = '';
                    setTimeout(() => window.location.href = data.redirect, 3000);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || errorData.details || 'Failed to process project');
                }
            } catch (error) {
                console.error('Error processing project:', error);
                Toastify({ text: error.message || 'Error processing project', duration: 3000, style: { background: '#e74c3c' } }).showToast();
            }
        }
    }

    if (cancelUploadBtn) {
        cancelUploadBtn.addEventListener('click', () => {
            uploadForm.reset();
            selectedCollaboratorIds = [];
            selectedCollaboratorsDisplay.innerHTML = '';
            updateCollaboratorIdsHiddenInput();
            dynamicFieldsContainer.innerHTML = '';
            Toastify({ text: 'Upload cancelled', duration: 2000, style: { background: '#6c757d' } }).showToast();
        });
    }

    window.addEventListener('load', () => {
        window.loadUserProfileInHeader();
        loadProjectSchemas();
    });
});
</script>
</body>
</html>