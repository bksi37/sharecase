<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Public Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_project_cards.css">
    <link rel="stylesheet" href="/css/_public_profile.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture">
                <span id="headerProfileName">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: flex;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    
    <main class="container-fluid py-4">
        <div class="container py-4">
            <div class="profile-layout">
                <div class="profile-sidebar">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <img id="publicProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile" class="avatar-img">
                        </div>
                        <div class="profile-details">
                            <h1 id="publicProfileName">Loading Name...</h1>
                            <div class="profile-meta">
                                <span id="publicProfileMajor" class="d-block"></span>
                                <span id="publicProfileDepartment" class="d-block"></span>
                                <p id="publicProfileBio" class="mt-2 text-muted"></p>
                            </div>
                            <div class="profile-stats">
                                <span><i class="fas fa-users"></i> <strong id="publicProfileFollowersCount">0</strong>&nbsp;Followers</span>
                                
                                <div class="dropdown mt-2">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="followersDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="display: none;">
                                        View Followers
                                    </button>
                                    <ul class="dropdown-menu" id="followersDropdownMenu" aria-labelledby="followersDropdown"></ul>
                                </div>
                            </div>
                            <div class="social-links">
                                <a href="#" target="_blank" style="display:none;" id="publicGithubLink"><i class="fab fa-github"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicLinkedinLink"><i class="fab fa-linkedin"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicWebsiteLink"><i class="fas fa-globe"></i></a>
                            </div>
                            <button class="btn btn-outline-primary mt-3 w-100" id="followButton" title="Follow or unfollow this user" aria-label="Follow this user" style="display: none;">Follow</button>
                        </div>
                    </div>
                </div>
                <div class="profile-content">
                    <div class="profile-section">
                        <h2 class="section-title">Projects</h2>
                        <hr class="section-divider">
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 project-grid" id="public-projects">
                            <p class="text-muted text-center w-100" id="projectsLoadingMessage">Loading projects...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Search Filters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="courseFilter" class="form-label">Course</label>
                        <select id="courseFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="yearFilter" class="form-label">Year</label>
                        <select id="yearFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="typeFilter" class="form-label">Type</label>
                        <select id="typeFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <select id="departmentFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select id="categoryFilter" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="applyFilters">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
    <script>
        async function loadPublicProfileDetails() {
            let userId = new URLSearchParams(window.location.search).get('userId');
            
            // ðŸ›‘ FIX 1: Extract userId from the clean path /profile/:userId (Preferred)
            if (!userId) {
                const pathMatch = window.location.pathname.match(/^\/profile\/([0-9a-f]{24})$/);
                if (pathMatch) {
                    userId = pathMatch[1];
                }
            }
            
            if (!userId) {
                Toastify({ text: 'Error: No public profile ID specified.', duration: 3000, style: { background: '#e74c3c' }}).showToast();
                document.getElementById('publicProfileName').textContent = 'Error: Invalid User ID';
                return;
            }

            let currentUserData = { isLoggedIn: false };
            try {
                // Ensure user data is loaded for follow logic
                await window.loadUserProfileInHeader();
                currentUserData = window.cachedUserData || { isLoggedIn: false };
            } catch (error) {
                console.warn('Could not fetch current user, proceeding as guest.');
            }

            try {
                // Fetch User Details (Path: /user-details/:userId from authRoutes)
                const userResponse = await fetch(`/user-details/${userId}`, {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                if (!userResponse.ok) {
                    throw new Error(`Failed to load public profile details: ${userResponse.statusText}`);
                }
                const user = await userResponse.json();

                // Fetch User Projects (Path: /projects/projects-by-user/:userId from projectRoutes)
                const projectsResponse = await fetch(`/projects/projects-by-user/${userId}`, {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                if (!projectsResponse.ok) {
                    // This error was the original 404 in the console!
                    throw new Error(`Failed to load user projects: ${projectsResponse.statusText}`);
                }
                const projects = await projectsResponse.json();

                // --- UI UPDATES ---
                document.getElementById('publicProfileName').textContent = user.name || 'N/A';
                document.getElementById('publicProfilePic').src = user.profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg';
                document.getElementById('publicProfileMajor').textContent = user.major || '';
                document.getElementById('publicProfileDepartment').textContent = user.department || '';
                document.getElementById('publicProfileFollowersCount').textContent = user.followersCount || 0;

                // Bio (Assuming you want to display this if available)
                const publicProfileBio = document.getElementById('publicProfileBio');
                if (publicProfileBio) publicProfileBio.textContent = user.bio || '';


                // Social Links
                const publicGithubLink = document.getElementById('publicGithubLink');
                const publicLinkedinLink = document.getElementById('publicLinkedinLink');
                const publicWebsiteLink = document.getElementById('publicWebsiteLink');
                const socialLinks = document.querySelector('.social-links');

                if (user.socialLinks) {
                    socialLinks.style.display = 'block';
                    if (user.socialLinks.github) { publicGithubLink.href = user.socialLinks.github; publicGithubLink.style.display = 'inline-block'; }
                    if (user.socialLinks.linkedin) { publicLinkedinLink.href = user.socialLinks.linkedin; publicLinkedinLink.style.display = 'inline-block'; }
                    if (user.socialLinks.website) { publicWebsiteLink.href = user.socialLinks.website; publicWebsiteLink.style.display = 'inline-block'; }
                } else {
                    socialLinks.style.display = 'none';
                }

                // Projects Grid
                const publicProjectsGrid = document.getElementById('public-projects');
                if (publicProjectsGrid) {
                    if (projects && projects.length > 0) {
                        publicProjectsGrid.innerHTML = projects.map(p => window.renderProjectCard(p)).join('');
                    } else {
                        publicProjectsGrid.innerHTML = '<p class="text-muted text-center w-100">No public projects available.</p>';
                    }
                }

                // Follow Button Logic
                const followButton = document.getElementById('followButton');
                const currentUserId = window.currentLoggedInUserId;
                const isFollowing = currentUserData.isLoggedIn && Array.isArray(currentUserData.user?.following) 
                    ? currentUserData.user.following.map(id => id.toString()).includes(userId) 
                    : false;

                if (followButton) {
                    if (!currentUserData.isLoggedIn || currentUserId === userId) {
                        // Hide button if not logged in or viewing own profile
                        followButton.style.display = 'none';
                    } else {
                        followButton.style.display = 'block';
                        followButton.textContent = isFollowing ? 'Following' : 'Follow';
                        followButton.classList.toggle('btn-primary', isFollowing);
                        followButton.classList.toggle('btn-outline-primary', !isFollowing);
                        followButton.onclick = () => window.toggleFollow(userId, followButton, loadPublicProfileDetails);
                    }
                }
                
                // Followers Dropdown (Updated URL for followers/following is correct in the original script)
                const followersDropdown = document.getElementById('followersDropdown');
                const followersDropdownMenu = document.getElementById('followersDropdownMenu');
                if (user.followersCount > 0 && followersDropdown && followersDropdownMenu) {
                    // Fetch followers only when dropdown button is clicked (or initially shown)
                    followersDropdown.style.display = 'block';
                    
                    // Logic to load followers list for the dropdown
                    const loadFollowersList = async () => {
                        try {
                            const followersResponse = await fetch(`/user/${userId}/followers`, { headers: { 'Accept': 'application/json' }, credentials: 'include' });
                            if (!followersResponse.ok) throw new Error('Failed to load followers list');
                            const followers = await followersResponse.json();
                            
                            followersDropdownMenu.innerHTML = followers.length > 0 ? followers.map(f => `
                                <li>
                                    <a class="dropdown-item" href="/profile/${f._id}">
                                        <img src="${f.profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg'}" alt="${f.name}'s profile picture" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                                        <span>${f.name}</span>
                                        <span class="text-muted d-block" style="font-size: 0.8rem;">${f.major || ''}</span>
                                    </a>
                                </li>
                            `).join('') : '<li><span class="dropdown-item text-muted">No followers</span></li>';
                        } catch (e) {
                            console.error('Error loading followers list:', e);
                            followersDropdownMenu.innerHTML = '<li><span class="dropdown-item text-danger">Error loading list.</span></li>';
                        }
                    };

                    // Attach load function to dropdown show event
                    followersDropdown.addEventListener('click', (e) => {
                         if (!followersDropdownMenu.classList.contains('show')) {
                            loadFollowersList();
                         }
                    });
                } else if (followersDropdown) {
                    followersDropdown.style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading public profile or projects:', error);
                Toastify({ text: error.message || 'Error loading public profile.', duration: 5000, style: { background: '#e74c3c' }}).showToast();
                document.getElementById('public-projects').innerHTML = '<p class="text-muted text-center w-100">Could not load projects. User may not exist or projects may not be public.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await window.loadUserProfileInHeader();
            loadPublicProfileDetails();

            // Setup for header search/filters
            if (typeof window.loadDynamicFilterOptions === 'function') {
                window.loadDynamicFilterOptions();
            }
            // Logic for search bar debounce/focus and apply filters button... (omitted for brevity, assume linked to scripts.js)
        });
    </script>
</body>
</html>