<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Public Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_project_cards.css">
    <link rel="stylesheet" href="/css/_public_profile.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture">
                <span id="headerProfileName">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: flex;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>

    <main class="container-fluid py-4">
        <div class="container py-4">
            <div class="profile-layout">
                <div class="profile-sidebar">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <img id="publicProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile" class="avatar-img">
                        </div>
                        <div class="profile-details">
                            <h1 id="publicProfileName">Loading Name...</h1>
                            <div class="profile-meta">
                                <span id="publicProfileMajor"></span>
                                <span id="publicProfileDepartment"></span>
                                <span id="publicProfileBio"></span>
                            </div>
                            <div class="profile-stats">
                                <span><i class="fas fa-users"></i> <strong id="publicProfileFollowersCount">0</strong>&nbsp;Followers</span>
                                <span><i class="fas fa-user-plus"></i> <strong id="publicProfileFollowingCount">0</strong>&nbsp;Following</span>
                            </div>
                            <div class="social-links">
                                <a href="#" target="_blank" style="display:none;" id="publicGithubLink"><i class="fab fa-github"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicLinkedinLink"><i class="fab fa-linkedin"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicWebsiteLink"><i class="fas fa-globe"></i></a>
                            </div>
                            <button class="btn btn-outline-primary mt-3 w-100" id="followButton" style="display:none;">Follow</button>
                        </div>
                    </div>
                </div>
                <div class="profile-content">
                    <div class="profile-section">
                        <h2 class="section-title">Projects</h2>
                        <hr class="section-divider">
                        <div class="project-grid" id="public-projects">
                            <p class="text-muted text-center">Loading projects...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="/js/scripts.js"></script>
<script>
    // These variables are now declared globally in scripts.js, so they are available here.
    // The previous declarations (let searchTimeout; const DEBOUNCE_DELAY = 300;) were removed.

    async function loadPublicProfileDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');

        if (!userId) {
            Toastify({ text: 'No user ID provided.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
            setTimeout(() => window.location.href = '/index.html', 3000); 
            return;
        }

        try {
            const userResponse = await fetch(`/user-details/${userId}`, { credentials: 'include' });
            if (!userResponse.ok) {
                throw new Error('Failed to load public profile details.');
            }
            const user = await userResponse.json();

            const projectsResponse = await fetch(`/projects-by-user/${userId}`, { credentials: 'include' });
            if (!projectsResponse.ok) {
                throw new Error('Failed to load user projects.');
            }
            const projects = await projectsResponse.json();

            document.getElementById('publicProfileName').textContent = user.name || 'N/A';
            document.getElementById('publicProfilePic').src = user.profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg';
            document.getElementById('publicProfileMajor').textContent = user.major || '';
            document.getElementById('publicProfileDepartment').textContent = user.department || '';
            document.getElementById('publicProfileBio').textContent = user.bio || '';
            document.getElementById('publicProfileFollowersCount').textContent = user.followersCount || 0;
            document.getElementById('publicProfileFollowingCount').textContent = user.followingCount || 0;

            const publicGithubLink = document.getElementById('publicGithubLink');
            const publicLinkedinLink = document.getElementById('publicLinkedinLink');
            const publicWebsiteLink = document.getElementById('publicWebsiteLink');

            if (user.socialLinks?.github && publicGithubLink) {
                publicGithubLink.href = user.socialLinks.github;
                publicGithubLink.style.display = 'inline-block';
            }
            if (user.socialLinks?.linkedin && publicLinkedinLink) {
                publicLinkedinLink.href = user.socialLinks.linkedin;
                publicLinkedinLink.style.display = 'inline-block';
            }
            if (user.socialLinks?.website && publicWebsiteLink) {
                publicWebsiteLink.href = user.socialLinks.website;
                publicWebsiteLink.style.display = 'inline-block';
            }

            const publicProjectsGrid = document.getElementById('public-projects');
            if (publicProjectsGrid) {
                if (projects && projects.length > 0) {
                    publicProjectsGrid.innerHTML = projects.map(p => renderProjectCard(p)).join('');
                } else {
                    publicProjectsGrid.innerHTML = '<p class="text-muted text-center">No public projects available.</p>';
                }
            }

            const followButton = document.getElementById('followButton');
            if (followButton && typeof currentLoggedInUserId !== 'undefined' && currentLoggedInUserId !== null) {
                if (currentLoggedInUserId === userId) {
                    followButton.style.display = 'none';
                } else {
                    followButton.style.display = 'block';
                    if (isUserFollowing(userId)) {
                        followButton.textContent = 'Unfollow';
                        followButton.classList.remove('btn-outline-primary');
                        followButton.classList.add('btn-primary');
                    } else {
                        followButton.textContent = 'Follow';
                        followButton.classList.remove('btn-primary');
                        followButton.classList.add('btn-outline-primary');
                    }
                    followButton.onclick = () => toggleFollow(userId, followButton, loadPublicProfileDetails);
                }
            } else if (followButton) {
                followButton.style.display = 'none';
            }

        } catch (error) {
            console.error('Error loading public profile or projects:', error);
            Toastify({
                text: error.message || 'Error loading public profile.',
                duration: 3000,
                style: { background: '#e74c3c' },
            }).showToast();
            document.getElementById('public-projects').innerHTML = '<p class="text-muted text-center">Could not load projects.</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadUserProfileInHeader();
        loadPublicProfileDetails();

        const searchInput = document.getElementById('searchInput');
        const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');
        const courseFilter = document.getElementById('courseFilter');
        const yearFilter = document.getElementById('yearFilter');
        const typeFilter = document.getElementById('typeFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const categoryFilter = document.getElementById('categoryFilter');

        if (courseFilter && yearFilter && typeFilter && departmentFilter && categoryFilter) {
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                    performGlobalSearch();
                    const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
                    if (filterModal) filterModal.hide();
                });
            }
        }

        if (searchInput) {
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performGlobalSearch, DEBOUNCE_DELAY);
            });
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim() && autocompleteSuggestions.children.length > 0) {
                    autocompleteSuggestions.style.display = 'block';
                }
            });
        }
        document.addEventListener('click', (event) => {
            if (autocompleteSuggestions && !autocompleteSuggestions.contains(event.target) && event.target !== searchInput) {
                autocompleteSuggestions.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>
