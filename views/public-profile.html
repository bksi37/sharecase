<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Public Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_project_cards.css">
    <link rel="stylesheet" href="/css/_public_profile.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dphfedhek/image/upload/v1/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="search-bar-container position-relative">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search projects, users...">
                <button class="btn btn-outline-secondary" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="user-menu">
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture">
                <span id="headerProfileName">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: flex;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    
    <main class="container-fluid py-4">
        <div class="container py-4">
            <div class="profile-layout">
                <div class="profile-sidebar">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <img id="publicProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile" class="avatar-img">
                        </div>
                        <div class="profile-details">
                            <h1 id="publicProfileName">Loading Name...</h1>
                            <div class="profile-meta">
                                <span id="publicProfileMajor"></span>
                                <span id="publicProfileDepartment"></span>
                                <span id="publicProfileBio"></span>
                            </div>
                            <div class="profile-stats">
                                <span><i class="fas fa-users"></i> <strong id="publicProfileFollowersCount">0</strong>&nbsp;Followers</span>
                                <!-- Followers dropdown -->
                                <div class="dropdown mt-2">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="followersDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="display: none;">
                                        View Followers
                                    </button>
                                    <ul class="dropdown-menu" id="followersDropdownMenu" aria-labelledby="followersDropdown"></ul>
                                </div>
                            </div>
                            <div class="social-links">
                                <a href="#" target="_blank" style="display:none;" id="publicGithubLink"><i class="fab fa-github"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicLinkedinLink"><i class="fab fa-linkedin"></i></a>
                                <a href="#" target="_blank" style="display:none;" id="publicWebsiteLink"><i class="fas fa-globe"></i></a>
                            </div>
                            <button class="btn btn-outline-primary mt-3 w-100" id="followButton" title="Follow or unfollow this user" aria-label="Follow this user" style="display: none;">Follow</button>
                        </div>
                    </div>
                </div>
                <div class="profile-content">
                    <div class="profile-section">
                        <h2 class="section-title">Projects</h2>
                        <hr class="section-divider">
                        <div class="project-grid" id="public-projects">
                            <p class="text-muted text-center">Loading projects...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>

    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Search Filters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="courseFilter" class="form-label">Course</label>
                        <select id="courseFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="yearFilter" class="form-label">Year</label>
                        <select id="yearFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="typeFilter" class="form-label">Type</label>
                        <select id="typeFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <select id="departmentFilter" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select id="categoryFilter" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="applyFilters">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
    <script>
        async function loadPublicProfileDetails() {
            console.log('Current URL:', window.location.href);
            console.log('Query params:', window.location.search);
            let userId = new URLSearchParams(window.location.search).get('userId');
            console.log('Query userId:', userId);

            if (!userId) {
                const pathMatch = window.location.pathname.match(/^\/profile\/([0-9a-f]{24})$/);
                if (pathMatch) {
                    userId = pathMatch[1];
                    console.log('Path userId:', userId);
                }
            }

            let currentUserData;
            try {
                console.log('Before loadUserProfileInHeader - currentLoggedInUserId:', window.currentLoggedInUserId);
                await window.loadUserProfileInHeader();
                console.log('After loadUserProfileInHeader - currentLoggedInUserId:', window.currentLoggedInUserId);
                currentUserData = await fetch('/current-user', {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                }).then(res => {
                    console.log('Current user response status:', res.status);
                    return res.json();
                });
                console.log('Current user data:', JSON.stringify(currentUserData, null, 2));
            } catch (error) {
                console.error('Error fetching current user:', error);
                currentUserData = { isLoggedIn: false };
            }

            if (!userId) {
                Toastify({
                    text: currentUserData.isLoggedIn ? 'Error: No public profile ID specified in the URL.' : 'No user ID provided. Redirecting to login...',
                    duration: 3000,
                    style: { background: '#e74c3c' }
                }).showToast();
                if (!currentUserData.isLoggedIn) {
                    setTimeout(() => window.location.href = '/login.html', 3000);
                }
                return;
            }

            try {
                const userResponse = await fetch(`/user-details/${userId}`, {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                console.log('User details response status:', userResponse.status);
                if (!userResponse.ok) {
                    throw new Error(`Failed to load public profile details: ${userResponse.statusText}`);
                }
                const user = await userResponse.json();
                console.log('Public profile data:', JSON.stringify(user, null, 2));

                const projectsResponse = await fetch(`/projects-by-user/${userId}`, {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                console.log('Projects response status:', projectsResponse.status);
                if (!projectsResponse.ok) {
                    throw new Error(`Failed to load user projects: ${projectsResponse.statusText}`);
                }
                const projects = await projectsResponse.json();
                console.log('User projects:', JSON.stringify(projects, null, 2));

                document.getElementById('publicProfileName').textContent = user.name || 'N/A';
                document.getElementById('publicProfilePic').src = user.profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg';
                document.getElementById('publicProfileMajor').textContent = user.major || '';
                document.getElementById('publicProfileDepartment').textContent = user.department || '';
                document.getElementById('publicProfileBio').textContent = user.bio || '';
                document.getElementById('publicProfileFollowersCount').textContent = user.followersCount || 0;

                const publicGithubLink = document.getElementById('publicGithubLink');
                const publicLinkedinLink = document.getElementById('publicLinkedinLink');
                const publicWebsiteLink = document.getElementById('publicWebsiteLink');
                const socialLinks = document.querySelector('.social-links');

                if (!user.socialLinks || (!user.socialLinks.github && !user.socialLinks.linkedin && !user.socialLinks.website)) {
                    socialLinks.style.display = 'none';
                } else {
                    socialLinks.style.display = 'block';
                    if (user.socialLinks?.github && publicGithubLink) {
                        publicGithubLink.href = user.socialLinks.github;
                        publicGithubLink.style.display = 'inline-block';
                    }
                    if (user.socialLinks?.linkedin && publicLinkedinLink) {
                        publicLinkedinLink.href = user.socialLinks.linkedin;
                        publicLinkedinLink.style.display = 'inline-block';
                    }
                    if (user.socialLinks?.website && publicWebsiteLink) {
                        publicWebsiteLink.href = user.socialLinks.website;
                        publicWebsiteLink.style.display = 'inline-block';
                    }
                }

                const publicProjectsGrid = document.getElementById('public-projects');
                if (publicProjectsGrid) {
                    if (projects && projects.length > 0) {
                        publicProjectsGrid.innerHTML = projects.map(p => window.renderProjectCard(p)).join('');
                    } else {
                        publicProjectsGrid.innerHTML = '<p class="text-muted text-center">No public projects available.</p>';
                    }
                }

                const followButton = document.getElementById('followButton');
                const currentUserId = currentUserData.isLoggedIn && currentUserData.user?._id ? currentUserData.user._id.toString() : null;
                const isFollowing = currentUserData.isLoggedIn && Array.isArray(currentUserData.user?.following) 
                    ? currentUserData.user.following.map(id => id.toString()).includes(userId) 
                    : false;

                console.log('Follow button check:', {
                    followButton: !!followButton,
                    currentUserId,
                    userId,
                    isDifferentUser: currentUserId !== userId,
                    isFollowing,
                    isLoggedIn: currentUserData.isLoggedIn
                });

                if (followButton) {
                    if (!currentUserData.isLoggedIn) {
                        followButton.style.display = 'block';
                        followButton.textContent = 'Follow';
                        followButton.setAttribute('aria-label', 'Follow this user (login required)');
                        followButton.classList.add('btn-outline-primary');
                        followButton.classList.remove('btn-primary');
                        followButton.onclick = () => {
                            window.location.href = `/login.html?redirectedFrom=${encodeURIComponent(`/profile/${userId}`)}`;
                        };
                    } else if (currentUserId && currentUserId !== userId) {
                        followButton.style.display = 'block';
                        followButton.textContent = isFollowing ? 'Following' : 'Follow';
                        followButton.setAttribute('aria-label', isFollowing ? 'Unfollow this user' : 'Follow this user');
                        followButton.classList.toggle('btn-primary', isFollowing);
                        followButton.classList.toggle('btn-outline-primary', !isFollowing);
                        followButton.onclick = () => window.toggleFollow(userId, followButton, () => {
                            loadPublicProfileDetails();
                        });
                    } else {
                        followButton.style.display = 'none';
                        followButton.style.margin = '0';
                    }
                }

                const followersDropdown = document.getElementById('followersDropdown');
                const followersDropdownMenu = document.getElementById('followersDropdownMenu');
                if (user.followersCount > 0 && followersDropdown && followersDropdownMenu) {
                    try {
                        const followersResponse = await fetch(`/user/${userId}/followers`, {
                            headers: { 'Accept': 'application/json' },
                            credentials: 'include'
                        });
                        console.log('Followers response status:', followersResponse.status);
                        if (!followersResponse.ok) {
                            throw new Error('Failed to load followers');
                        }
                        const followers = await followersResponse.json();
                        console.log('Followers data:', JSON.stringify(followers, null, 2));

                        followersDropdown.style.display = 'block';
                        if (followers.length > 0) {
                            followersDropdownMenu.innerHTML = followers.map(f => `
                                <li>
                                    <a class="dropdown-item" href="/profile/${f._id}">
                                        <img src="${f.profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg'}" alt="${f.name}'s profile picture" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                                        <span>${f.name}</span>
                                        <span class="text-muted d-block" style="font-size: 0.8rem;">${f.major || ''}</span>
                                    </a>
                                </li>
                            `).join('');
                        } else {
                            followersDropdownMenu.innerHTML = '<li><span class="dropdown-item text-muted">No followers</span></li>';
                        }
                    } catch (error) {
                        console.error('Error loading followers:', error);
                        followersDropdown.style.display = 'none';
                    }
                } else if (followersDropdown) {
                    followersDropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading public profile or projects:', error);
                Toastify({
                    text: error.message || 'Error loading public profile.',
                    duration: 3000,
                    style: { background: '#e74c3c' },
                }).showToast();
                document.getElementById('public-projects').innerHTML = '<p class="text-muted text-center">Could not load projects.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await window.loadUserProfileInHeader();
            loadPublicProfileDetails();

            const searchInput = document.getElementById('searchInput');
            const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');
            const courseFilter = document.getElementById('courseFilter');
            const yearFilter = document.getElementById('yearFilter');
            const typeFilter = document.getElementById('typeFilter');
            const departmentFilter = document.getElementById('departmentFilter');
            const categoryFilter = document.getElementById('categoryFilter');

            if (courseFilter && yearFilter && typeFilter && departmentFilter && categoryFilter) {
                const applyFiltersBtn = document.getElementById('applyFilters');
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', () => {
                        window.performGlobalSearch();
                        const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
                        if (filterModal) filterModal.hide();
                    });
                }
            }

            if (searchInput && autocompleteSuggestions) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(window.searchTimeout);
                    window.searchTimeout = setTimeout(window.performGlobalSearch, window.DEBOUNCE_DELAY);
                });
                searchInput.addEventListener('focus', () => {
                    if (searchInput.value.trim() && autocompleteSuggestions.children.length > 0) {
                        autocompleteSuggestions.style.display = 'block';
                    }
                });
                document.addEventListener('click', (event) => {
                    if (!autocompleteSuggestions.contains(event.target) && event.target !== searchInput) {
                        autocompleteSuggestions.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>