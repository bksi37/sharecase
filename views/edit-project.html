<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCase - Edit Project</title>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="shortcut icon" href="/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/_base.css">
    <link rel="stylesheet" href="/css/_header.css">
    <link rel="stylesheet" href="/css/_forms.css">
    <link rel="stylesheet" href="/css/_utilities.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="module" src="https://unpkg.com/@google/model-viewer@4.0.0/dist/model-viewer.min.js"></script>

    <style>
        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        .notification-item.unread {
            background-color: #e6f7ff;
            font-weight: 500;
        }
        .notification-item .message {
            flex-grow: 1;
            padding-right: 10px;
        }
        .notification-item button {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .notification-item:hover button {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header class="d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/index.html">
                <img src="https://res.cloudinary.com/dphfedhek/image/upload/sharecase-logo.png" alt="ShareCase Logo" style="height: 90px;">
            </a>
        </div>
        <div class="user-menu d-flex align-items-center">
            <a href="/store-placeholder.html" class="btn btn-outline-dark me-3" id="storeButton" aria-label="Store" title="Store">
                <i class="fas fa-store"></i>
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-dark me-2" id="notificationButton" aria-label="Notifications" title="Notifications" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bell"></i>
                    <span class="badge bg-danger" id="notificationCount" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 300px;">
                    <div class="dropdown-header">Notifications</div>
                    <div id="notificationList">
                        <div class="dropdown-item-text">No new notifications</div>
                    </div>
                </div>
            </div>
            <div class="profile-container" id="userMenuToggle" style="display: none;">
                <img id="headerProfilePic" src="https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg" alt="Profile Picture" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                <span id="headerProfileName" class="ms-2">Guest</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">Profile</a>
                    <a href="/settings.html" class="dropdown-item">Settings</a>
                    <a href="/upload-project.html" class="dropdown-item">Upload Project</a>
                    <a id="adminDashboardLink" href="/admin/dashboard.html" class="dropdown-item" style="display: none;">Admin Dashboard</a>
                    <a id="careerCenterDashboardLink" href="/admin/career-center-dashboard.html" class="dropdown-item" style="display: none;">Career Center Dashboard</a>
                    <a id="logoutLink" href="/logout" class="dropdown-item">Logout</a>
                    <a href="/about.html" class="dropdown-item">About</a>
                    <div class="dropdown-item-text text-muted small mt-2">
                        Role: <span id="userRoleDisplay"></span><br>
                        Points: <span id="userPointsDisplay"></span>
                    </div>
                </div>
            </div>
            <div id="authControls" style="display: none;">
                <a href="/login.html" class="btn btn-primary btn-sm">Login</a>
                <a href="/signup.html" class="btn btn-outline-primary btn-sm ms-2">Sign Up</a>
            </div>
        </div>
    </header>
    <main class="container my-5">
        <div class="card p-4 shadow-sm">
            <h2 class="mb-4" id="editFormTitle">Edit Project</h2>
            <form id="editForm" enctype="multipart/form-data" aria-labelledby="editFormTitle">
                <input type="hidden" id="projectId" name="projectId">
                
                <div class="mb-3">
                    <label for="title" class="form-label">Project Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" required aria-required="true" placeholder="e.g., 3D Printed Drone">
                    <div class="invalid-feedback">Project Title is required.</div>
                </div>
                
                <div class="row mb-3 g-3">
                    <div class="col-md-6">
                        <label for="projectType" class="form-label">Project Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="projectType" name="projectType" required aria-required="true">
                            <option value="">Select Project Type</option>
                        </select>
                        <div class="invalid-feedback">Project Type is required to publish.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="">Select Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="description" name="description" rows="4" required aria-required="true" placeholder="A short, catchy summary (1-2 sentences)"></textarea>
                    <div class="invalid-feedback">Description is required to publish.</div>
                </div>
                
                <div class="mb-3">
                    <label for="problemStatement" class="form-label">Problem Statement</label>
                    <textarea class="form-control" id="problemStatement" name="problemStatement" rows="4" placeholder="What problem does your project solve?"></textarea>
                </div>
                
                <div id="dynamic-fields-container" class="mb-3 p-3 border rounded bg-light">
                    <p class="text-muted mb-0">Specific fields (e.g., CAD File, Technical Description) will appear here after selecting a Project Type.</p>
                </div>
                
                <div class="mb-3">
                    <label for="image" class="form-label">Project Image <span class="text-danger">*</span></label>
                    <div class="dropzone p-3 border rounded text-center" id="imageDropzone" role="region" aria-label="Dropzone for project image">
                        <p class="mb-0" id="imageDropzoneText">Drag & drop a new image or click to select (JPEG, PNG, GIF, max 2MB)</p>
                        <input type="file" class="form-control d-none" id="image" name="image" accept="image/jpeg,image/png,image/gif" aria-required="true">
                    </div>
                    <div id="imagePreviewContainer" class="mt-2">
                        <p class="mb-1 text-muted small">Current Image:</p>
                        <img id="imagePreview" src="" alt="Image preview" class="rounded" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="removeImageBtn" style="display: none;">Remove Current Image</button>
                    </div>
                    <div class="invalid-feedback">Project Image is required to publish.</div>
                </div>

                <div class="mb-3">
                    <label for="tags" class="form-label">Tags <span class="text-danger">*</span></label>
                    <select class="form-select" id="tags" name="tags" multiple required aria-required="true">
                        <option value="" disabled>Select tags</option>
                    </select>
                    <small class="form-text text-muted">Select relevant tags (e.g., SolidWorks, Python). Hold Ctrl/Cmd to select multiple.</small>
                    <div class="invalid-feedback">At least one tag is required to publish.</div>
                </div>
                
                <div class="mb-3 position-relative">
                    <label class="form-label">Collaborators (Registered Users)</label>
                    <div class="form-control collaborator-input-container p-2" style="min-height: 50px;">
                        <div id="selectedCollaboratorsDisplay" class="d-flex flex-wrap gap-2 mb-2"></div>
                        <input type="text" id="collaboratorSearchInput" class="collaborator-search-input w-100 border-0" placeholder="Search by name or email..." aria-label="Search for collaborators">
                    </div>
                    <div id="collaboratorSearchResults" class="list-group position-absolute w-100 mt-1 shadow" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000;"></div>
                    <input type="hidden" id="collaboratorIds" name="collaboratorIds">
                </div>
                
                <div class="mb-3">
                    <label for="otherContributors" class="form-label">Other Contributors</label>
                    <input type="text" class="form-control" id="otherContributors" name="otherContributors" placeholder="e.g., Professor X, Guest Speaker">
                    <small class="form-text text-muted">For non-registered contributors (faculty, mentors).</small>
                </div>
                
                <div class="mb-3">
                    <label for="resources" class="form-label">Resources (comma-separated URLs)</label>
                    <input type="text" class="form-control" id="resources" name="resources" placeholder="e.g., https://github.com/user/repo">
                    <small class="form-text text-muted">Links to documentation, source code, or other files.</small>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
                    <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn">Cancel</button>
                </div>
                <small class="d-block mt-3 text-danger">Fields marked with (<span class="text-danger">*</span>) are required for publishing.</small>
            </form>
        </div>
    </main>

    <footer class="text-center py-3">
        <p>Â© 2025 ShareCase. All rights reserved.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/js/scripts.js"></script>
    
    <script type="module">
        // --- Global Variables/Constants ---
        const DEBOUNCE_DELAY_SEARCH = 300;
        let debounceTimeout;
        let selectedCollaboratorIds = [];
        window.selectedCollaboratorIds = selectedCollaboratorIds;
        window.projectSchemas = { Default: [] }; 
        let currentProjectData = {}; // Stores project data after load

        // --- DOM Elements ---
        const editForm = document.getElementById('editForm');
        const projectTypeSelect = document.getElementById('projectType');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        const collaboratorSearchInput = document.getElementById('collaboratorSearchInput');
        const collaboratorSearchResults = document.getElementById('collaboratorSearchResults');
        const selectedCollaboratorsDisplay = document.getElementById('selectedCollaboratorsDisplay');
        const collaboratorIdsHiddenInput = document.getElementById('collaboratorIds');
        const imageInput = document.getElementById('image');
        const imageDropzone = document.getElementById('imageDropzone');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const tagsSelect = document.getElementById('tags'); 
        const yearSelect = document.getElementById('year');
        const departmentSelect = document.getElementById('department');
        const categorySelect = document.getElementById('category');

        // --- Local Notification Functions (Required for Header) ---
        async function deleteNotification(notificationId) {
            if (!confirm('Remove this notification?')) return;
            try {
                const response = await fetch(`/notifications/${notificationId}`, {
                    method: 'DELETE', credentials: 'include'
                });
                if (response.ok) {
                    Toastify({ text: 'Notification removed.', duration: 2000, style: { background: '#ff5858' } }).showToast();
                    fetchNotifications(); 
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to remove notification.');
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                Toastify({ text: error.message, duration: 3000, style: { background: '#e74c3c' } }).showToast();
            }
        }

        async function fetchNotifications() {
            const notificationList = document.getElementById('notificationList');
            const notificationCount = document.getElementById('notificationCount');
            if (!notificationList || !notificationCount) return;

            notificationList.innerHTML = '<div class="dropdown-item-text text-muted">Fetching...</div>';
            notificationCount.style.display = 'none';

            try {
                const response = await fetch('/notifications', { credentials: 'include' });
                if (response.status === 401) {
                    notificationList.innerHTML = '<div class="dropdown-item-text">Please log in to view notifications.</div>';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`Failed to fetch notifications: Status ${response.status}`);
                }
                const notifications = await response.json();
                const unreadCount = notifications.filter(n => !n.read).length;
                
                notificationList.innerHTML = notifications.length > 0
                    ? notifications.map(n => `
                        <div class="notification-item ${n.read ? '' : 'unread'}" data-id="${n._id}" title="${n.read ? 'Read' : 'Unread'}">
                            <span class="message">${n.message}</span>
                            <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteNotification('${n._id}')" aria-label="Remove notification">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')
                    : '<div class="dropdown-item-text">No new notifications</div>';
                    
                notificationCount.textContent = unreadCount;
                notificationCount.style.display = unreadCount > 0 ? 'inline' : 'none';

            } catch (error) {
                console.error('Error fetching notifications:', error);
                document.getElementById('notificationList').innerHTML = `<div class="dropdown-item-text text-danger">Error loading: ${error.message}</div>`;
                document.getElementById('notificationCount').style.display = 'none';
                Toastify({ text: 'Error loading notifications.', duration: 5000, style: { background: '#e74c3c' } }).showToast();
            }
        }

        // --- Utility Functions ---
        function validateFileSize(input, maxSizeMB, fieldName) {
            if (input.files && input.files[0]) {
                const fileSizeMB = input.files[0].size / (1024 * 1024);
                if (fileSizeMB > maxSizeMB) {
                    Toastify({ text: `${fieldName} exceeds ${maxSizeMB}MB limit.`, duration: 3000, style: { background: '#e74c3c' } }).showToast();
                    input.value = '';
                    const previewElement = document.getElementById(`${input.id}PreviewContainer`) || imagePreviewContainer;
                    if (previewElement) previewElement.style.display = 'none';
                    return false;
                }
                return true;
            }
            return true;
        }

        function previewImage(file, previewImgElement, previewContainerElement, hideRemoveBtn = false) {
            if (file && ['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImgElement.src = e.target.result;
                    previewImgElement.style.display = 'block';
                    previewContainerElement.style.display = 'block';
                    removeImageBtn.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else if (typeof file === 'string') { // For initial load with a URL
                previewImgElement.src = file;
                previewImgElement.style.display = 'block';
                previewContainerElement.style.display = 'block';
                removeImageBtn.style.display = hideRemoveBtn ? 'none' : 'block';
            } else {
                previewImgElement.style.display = 'none';
                previewImgElement.src = '';
                previewContainerElement.style.display = 'none';
                removeImageBtn.style.display = 'none';
            }
        }

        function previewCADFile(file) {
            const previewContainer = document.getElementById('CADFilePreviewContainer');
            if (!previewContainer) return;
            const modelViewer = previewContainer.querySelector('model-viewer');
            
            if (file instanceof File && file.name.match(/\.(obj|stl|gltf|glb)$/i)) {
                const fileURL = URL.createObjectURL(file);
                modelViewer.src = fileURL;
                previewContainer.style.display = 'block';

                modelViewer.addEventListener('load', () => {
                    setTimeout(() => URL.revokeObjectURL(fileURL), 5000);
                }, { once: true });

            } else if (typeof file === 'string' && file.match(/\.(obj|stl|gltf|glb)$/i)) { // For initial load with a URL
                modelViewer.src = file;
                previewContainer.style.display = 'block';
            } else {
                previewContainer.style.display = 'none';
                modelViewer.src = ''; // Clear source
                if (file instanceof File && file.name.match(/\.step$/i)) {
                    Toastify({ text: 'STEP files cannot be previewed in-browser. Use OBJ, GLTF, or STL.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                }
            }
        }

        function setupDropzone(dropzone, fileInput) {
            if (!dropzone || !fileInput) return;
            dropzone.addEventListener('click', () => fileInput.click());
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('bg-light');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('bg-light');
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('bg-light');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }
        
        function populateDropdown(selectElement, options, defaultText = 'Select...') {
            if (!selectElement) return;
            selectElement.innerHTML = `<option value="">${defaultText}</option>`;
            options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }

        function renderDynamicFields(projectSpecificFields = {}) {
            dynamicFieldsContainer.innerHTML = '';
            const selectedType = projectTypeSelect.value || 'Default';
            const schema = window.projectSchemas[selectedType] || window.projectSchemas.Default;
            
            if (schema.length === 0 && selectedType !== 'Default') {
                dynamicFieldsContainer.innerHTML = '<p class="text-muted mb-0">No specific fields required for this project type.</p>';
                return;
            } else if (selectedType === 'Default') {
                dynamicFieldsContainer.innerHTML = '<p class="text-muted mb-0">Specific fields (e.g., CAD File, Technical Description) will appear here after selecting a Project Type.</p>';
                return;
            }

            schema.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.classList.add('mb-3');
                const requiredAttr = field.required ? 'required aria-required="true"' : '';
                const fieldId = field.name;
                const fieldLabel = field.label;
                
                let currentValue = projectSpecificFields[fieldId];
                if (Array.isArray(currentValue)) {
                     currentValue = currentValue.join(', ');
                } else if (currentValue === undefined || currentValue === null) {
                    currentValue = '';
                }
                
                let htmlContent = '';
                
                if (field.type === 'file') {
                    const isCAD = fieldId === 'CADFile';
                    const maxSizeMB = isCAD ? 10 : 2;
                    const currentFileUrl = currentValue; 

                    htmlContent = `
                        <label for="${fieldId}" class="form-label">${fieldLabel} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                        <div class="dropzone p-3 border rounded text-center" id="${fieldId}Dropzone" role="region" aria-label="Dropzone for ${fieldLabel}">
                            <p class="mb-0">Drag & drop a new ${fieldLabel} or click to select (${field.accept || 'Max 10MB'})</p>
                            <input type="file" class="form-control d-none" id="${fieldId}" name="${fieldId}" accept="${field.accept}">
                            <input type="hidden" id="${fieldId}Current" name="${fieldId}Current" value="${currentFileUrl}">
                        </div>
                        <div id="${fieldId}PreviewContainer" class="mt-2" style="display: ${currentFileUrl ? 'block' : 'none'};">
                            ${isCAD ? `
                                <small class="form-text text-muted mb-1 d-block">Current File Preview (upload new file to replace):</small>
                                <div id="${fieldId}Preview">
                                    <model-viewer src="${currentFileUrl}" alt="${fieldLabel} preview" camera-controls auto-rotate shadow-intensity="1" style="width: 100%; height: 300px; background-color: #f8f9fa;"></model-viewer>
                                </div>
                                <small class="form-text text-muted">Preview works best with GLB, GLTF, OBJ, or STL files. STEP files require download.</small>
                            ` : `
                                <small class="form-text text-muted mb-1 d-block">Current Image Preview (upload new image to replace):</small>
                                <img id="${fieldId}Preview" src="${currentFileUrl}" alt="${fieldLabel} preview" class="rounded" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                            `}
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 mt-2" data-remove-dynamic-file="${fieldId}">Remove Current File</button>
                        </div>
                        `;
                } else if (field.type === 'textarea') {
                    htmlContent = `
                        <label for="${fieldId}" class="form-label">${fieldLabel} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                        <textarea class="form-control" id="${fieldId}" name="${fieldId}" rows="4" placeholder="${field.placeholder}" ${requiredAttr}>${currentValue}</textarea>`;
                } else {
                    htmlContent = `
                        <label for="${fieldId}" class="form-label">${fieldLabel} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                        <input type="${field.type}" class="form-control" id="${fieldId}" name="${fieldId}" placeholder="${field.placeholder}" value="${currentValue}" ${requiredAttr}>`;
                }

                htmlContent += field.note ? `<small class="form-text text-muted">${field.note}</small>` : '';
                htmlContent += `<div class="invalid-feedback">${fieldLabel} is required.</div>`;

                fieldDiv.innerHTML = htmlContent;
                dynamicFieldsContainer.appendChild(fieldDiv);

                // --- ATTACH LISTENERS AFTER ELEMENTS EXIST ---
                if (field.type === 'file') {
                    const dropzone = document.getElementById(`${fieldId}Dropzone`);
                    const fileInput = document.getElementById(fieldId);
                    const currentFileHidden = document.getElementById(`${fieldId}Current`);
                    const previewContainer = document.getElementById(`${fieldId}PreviewContainer`);
                    const isCAD = fieldId === 'CADFile';
                    const maxSizeMB = isCAD ? 10 : 2;
                    
                    setupDropzone(dropzone, fileInput);
                    
                    fileInput.addEventListener('change', () => {
                        validateFileSize(fileInput, maxSizeMB, fieldLabel);
                        if (fileInput.files[0]) {
                            if (isCAD) {
                                previewCADFile(fileInput.files[0]);
                            } else {
                                previewImage(fileInput.files[0], document.getElementById(`${fieldId}Preview`), previewContainer, false);
                            }
                            currentFileHidden.value = ''; // Clear current file hidden input as a new one is being uploaded
                        }
                    });

                    // Remove File Button Listener
                    const removeBtn = document.querySelector(`[data-remove-dynamic-file="${fieldId}"]`);
                    if (removeBtn) {
                        removeBtn.addEventListener('click', () => {
                            if (confirm(`Are you sure you want to remove the current ${fieldLabel}?`)) {
                                currentFileHidden.value = 'DELETED'; // Signal to server to remove
                                fileInput.value = ''; // Clear file input
                                if (isCAD) {
                                    previewCADFile(null);
                                } else {
                                    previewImage(null, document.getElementById(`${fieldId}Preview`), previewContainer, false);
                                }
                                Toastify({ text: `${fieldLabel} marked for deletion on save.`, duration: 2000, style: { background: "#dc3545" } }).showToast();
                            }
                        });
                    }
                }
            });
        }

        // --- Collaboration Functions ---
        function updateCollaboratorIdsHiddenInput() { collaboratorIdsHiddenInput.value = selectedCollaboratorIds.join(','); }

        function addCollaboratorChip(userId, userName, profilePic, isInitialLoad = false) {
            const isValidObjectId = /^[0-9a-fA-F]{24}$/.test(userId);
            if (!isValidObjectId) {
                if (!isInitialLoad) { Toastify({ text: `Invalid user ID for ${userName}. Cannot add collaborator.`, duration: 3000, style: { background: "#e74c3c" } }).showToast(); }
                return;
            }
            if (selectedCollaboratorIds.includes(userId)) {
                if (!isInitialLoad) { Toastify({ text: `${userName} is already added.`, duration: 2000, style: { background: "#ffc107" } }).showToast(); }
                return;
            }

            selectedCollaboratorIds.push(userId);
            const chip = document.createElement('div');
            chip.classList.add('collaborator-chip', 'd-flex', 'align-items-center', 'bg-light', 'border', 'rounded', 'px-2', 'py-1');
            chip.setAttribute('data-user-id', userId);
            chip.innerHTML = `
                <img src="${profilePic || 'https://res.cloudinary.com/dphfedhek/image/upload/default-profile.jpg'}" class="rounded-circle me-1" style="width: 24px; height: 24px; object-fit: cover;" alt="${userName}">
                <span>${userName}</span>
                <button type="button" class="btn-close btn-close-small ms-2" aria-label="Remove collaborator"></button>
            `;
            chip.querySelector('.btn-close').addEventListener('click', () => {
                selectedCollaboratorIds = selectedCollaboratorIds.filter(id => id !== userId);
                chip.remove();
                updateCollaboratorIdsHiddenInput();
                Toastify({ text: `Collaborator removed`, duration: 2000, style: { background: "#dc3545" } }).showToast();
            });
            selectedCollaboratorsDisplay.appendChild(chip);
            updateCollaboratorIdsHiddenInput();
            
            if (!isInitialLoad) {
                collaboratorSearchInput.value = '';
                collaboratorSearchResults.style.display = 'none';
                Toastify({ text: `${userName} added as collaborator`, duration: 2000, style: { background: "#28a745" } }).showToast();
            }
        }
        
        // --- Validation and Submission ---
        function validateForm(isPublishing) {
            let isValid = true;
            editForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            const requiredFields = isPublishing ? ['title', 'projectType', 'description'] : ['title'];
            requiredFields.forEach(id => {
                const input = document.getElementById(id);
                if (input && !input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                }
            });
            
            if (isPublishing) {
                const hasNewImage = imageInput.files[0];
                const hasCurrentImage = imagePreview.src && imagePreview.src !== window.location.href;
                // Check if the current image is marked for deletion and no new one uploaded
                const isImageMarkedForDeletion = currentProjectData.image === 'DELETED'; 
                
                if (!hasNewImage && (!hasCurrentImage || isImageMarkedForDeletion)) { 
                    imageInput.classList.add('is-invalid'); 
                    isValid = false; 
                    Toastify({ text: 'Project Image is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast(); 
                } else {
                    imageInput.classList.remove('is-invalid');
                }

                const selectedTags = Array.from(tagsSelect.selectedOptions).map(option => option.value);
                const coreTags = [yearSelect.value, departmentSelect.value, categorySelect.value].filter(t => t);

                if (selectedTags.length === 0 && coreTags.length === 0) { 
                    tagsSelect.classList.add('is-invalid'); 
                    Toastify({ text: 'At least one tag is required to publish.', duration: 3000, style: { background: '#e74c3c' } }).showToast(); 
                    isValid = false; 
                } else {
                    tagsSelect.classList.remove('is-invalid');
                }
                
                // Validate dynamic required fields
                const schema = window.projectSchemas[projectTypeSelect.value] || window.projectSchemas.Default;
                schema.forEach(field => {
                    if (field.required) {
                        const input = document.getElementById(field.name);
                        const currentFileHidden = document.getElementById(`${field.name}Current`);

                        if (input && field.type === 'file') {
                            const isMarkedForDeletion = currentFileHidden?.value === 'DELETED';
                            const hasCurrentFile = currentFileHidden?.value && currentFileHidden.value !== 'DELETED';

                            if (!input.files[0] && (!hasCurrentFile || isMarkedForDeletion)) {
                                input.classList.add('is-invalid'); 
                                isValid = false; 
                            } else {
                                input.classList.remove('is-invalid');
                            }
                        } else if (input && !input.value.trim()) { 
                            input.classList.add('is-invalid'); 
                            isValid = false; 
                        }
                    }
                });
            }
            if (!isValid) { 
                Toastify({ text: 'Please check the form for required fields.', duration: 3000, style: { background: '#e74c3c' } }).showToast(); 
            }
            return isValid;
        }

        async function submitProject(isPublished) {
            const projectId = document.getElementById('projectId').value;
            if (!projectId) {
                Toastify({ text: 'Project ID is missing for update.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                return;
            }

            if (!validateForm(isPublished)) return;
            
            const formData = new FormData(editForm);
            
            // Set the final status
            formData.append('isPublished', isPublished ? 'true' : 'false');
            
            // Collect all selected tags
            const selectedTags = Array.from(tagsSelect.selectedOptions).map(option => option.value);
            const coreTags = [yearSelect.value, departmentSelect.value, categorySelect.value].filter(t => t);
            
            formData.delete('tags'); 
            formData.append('tags', [...new Set([...selectedTags, ...coreTags])].join(','));

            try {
                // Ensure dynamic fields are included in the FormData
                const schema = window.projectSchemas[projectTypeSelect.value] || window.projectSchemas.Default;
                schema.forEach(field => {
                    const input = document.getElementById(field.name);
                    if (input && field.type !== 'file') {
                        formData.append(field.name, input.value);
                    }
                    // For file inputs, the File or the hidden *Current field is already in FormData by default
                });
                
                // Track image deletion separately
                if (currentProjectData.image === 'DELETED' && !imageInput.files[0]) {
                    formData.append('removeCurrentImage', 'true');
                }

                const response = await fetch(`/projects/${projectId}`, { method: 'PUT', body: formData, credentials: 'include' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server returned error text (Validation Error):', errorText);
                    
                    let errorData;
                    try { errorData = JSON.parse(errorText); } catch { errorData = { error: 'Unknown Error', details: errorText }; }

                    throw new Error(`HTTP error! Status: ${response.status}. ${errorData.details || errorData.error || response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const message = currentProjectData.isPublished ? 'Project changes saved!' : 'Draft saved successfully!';
                    Toastify({ text: data.message || message, duration: 3000, style: { background: '#28a745' } }).showToast();
                    
                    // Redirect to the project page or profile page based on the server response
                    setTimeout(() => window.location.href = data.redirect || `/project.html?id=${projectId}`, 3000);
                } else {
                    const errorMsg = data.error || data.details || 'Failed to update project.';
                    Toastify({ text: errorMsg, duration: 5000, style: { background: '#e74c3c' } }).showToast();
                }
            } catch (error) {
                console.error('Error submitting project:', error);
                Toastify({ text: 'A network error occurred during update: ' + error.message, duration: 5000, style: { background: '#e74c3c' } }).showToast();
            }
        }

        // --- Initial Load Logic ---
        async function loadProjectSchemas() {
            try {
                const response = await fetch('/projects/dynamic-filter-options', { credentials: 'include', headers: { 'Accept': 'application/json' } });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                
                window.projectSchemas = data.projectSchemas || { Default: [] };

                // Populate all selector fields
                populateDropdown(projectTypeSelect, data.types || ['Engineering', 'Art', 'Other'], 'Select Project Type');
                populateDropdown(yearSelect, data.years || [], 'Select Year');
                populateDropdown(departmentSelect, data.departments || [], 'Select Department');
                populateDropdown(categorySelect, data.categories || [], 'Select Category');
                populateDropdown(tagsSelect, data.tools || [], 'Select tags'); 
                
            } catch (error) {
                console.error('Error loading filter options (using fallback):', error);
                // Fallback schemas and options to prevent crash
                window.projectSchemas = { Default: [], Engineering: [{ name: 'CADFile', label: 'CAD File', type: 'file', accept: '.gltf,.glb', required: false, note: 'Upload STL, OBJ, GLTF, GLB, or STEP (max 10MB).' }, { name: 'technicalDescription', label: 'Technical Description', type: 'textarea', placeholder: 'Describe the technical aspects of your project.', required: true }, { name: 'toolsSoftware', label: 'Tools/Software Used', type: 'text', placeholder: 'e.g., SolidWorks, AutoCAD', required: true }, { name: 'functionalGoals', label: 'Functional Goals', type: 'textarea', placeholder: 'What are the functional objectives?', required: false }], Art: [{ name: 'artworkImage', label: 'Artwork Image', type: 'file', accept: 'image/jpeg,image/png,image/gif', required: true, note: 'Upload JPEG, PNG, or GIF (max 2MB)' }, { name: 'mediumTechnique', label: 'Medium/Technique', type: 'text', placeholder: 'e.g., Oil on Canvas', required: true }, { name: 'artistStatement', label: 'Artist Statement', type: 'textarea', placeholder: 'Describe the concept behind your artwork.', required: true }, { name: 'exhibitionHistory', label: 'Exhibition History', type: 'text', placeholder: 'e.g., Exhibited at Art Fair 2023', required: false }] };
                populateDropdown(projectTypeSelect, ['Engineering', 'Art', 'Other'], 'Select Project Type');
                populateDropdown(yearSelect, ['2020', '2021', '2022', '2023', '2024', '2025'], 'Select Year');
                populateDropdown(departmentSelect, ['Mechanical Engineering', 'Computer Science', 'Fine Arts'], 'Select Department');
                populateDropdown(categorySelect, ['Robotics', 'Software', 'Painting'], 'Select Category');
                populateDropdown(tagsSelect, ['SolidWorks', 'Python', 'AutoCAD', 'Photoshop'], 'Select tags');
            }
        }

        async function loadProjectData() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            if (!projectId) {
                Toastify({ text: 'No project ID provided.', duration: 3000, style: { background: '#e74c3c' } }).showToast();
                setTimeout(() => window.location.href = '/profile.html', 3000);
                return;
            }
            document.getElementById('projectId').value = projectId;

            try {
                const projectResponse = await fetch(`/projects/project/${projectId}`, { credentials: 'include' });
                
                if (!projectResponse.ok) {
                    const errorText = await projectResponse.text();
                    console.error('Server response text:', errorText);
                    throw new Error(`Failed to load project details. Status: ${projectResponse.status}`);
                }
                const project = await projectResponse.json();
                currentProjectData = project; 
                
                // Populate basic form fields
                document.getElementById('title').value = project.title || '';
                document.getElementById('description').value = project.description || '';
                document.getElementById('problemStatement').value = project.problemStatement || '';
                
                const contributorValue = project.otherContributors
                    ? (Array.isArray(project.otherContributors) 
                        ? project.otherContributors.join(', ') 
                        : project.otherContributors) 
                    : '';
                document.getElementById('otherContributors').value = contributorValue;

                document.getElementById('resources').value = project.resources?.join(', ') || '';
                
                // Set Project Type (must be set before calling renderDynamicFields)
                projectTypeSelect.value = project.projectType || ''; 

                // Populate core select dropdowns based on tags array
                if (project.tags && project.tags.length > 0) {
                    project.tags.forEach(tag => {
                        if (yearSelect.querySelector(`option[value="${tag}"]`)) yearSelect.value = tag;
                        else if (departmentSelect.querySelector(`option[value="${tag}"]`)) departmentSelect.value = tag;
                        else if (categorySelect.querySelector(`option[value="${tag}"]`)) categorySelect.value = tag;
                    });
                }
                
                // Pre-select multiple tags
                if (project.tags && project.tags.length > 0) {
                    Array.from(tagsSelect.options).forEach(option => {
                        if (project.tags.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                }

                // Image Preview
                if (project.image) {
                    previewImage(project.image, imagePreview, imagePreviewContainer, false);
                    document.getElementById('imageDropzoneText').textContent = 'Drag & drop a NEW image to replace the current one.';
                } else {
                    document.getElementById('imageDropzoneText').textContent = 'Drag & drop an image or click to select (JPEG, PNG, GIF, max 2MB)';
                    imagePreviewContainer.style.display = 'none';
                }

                // Populate collaborators
                selectedCollaboratorIds = [];
                selectedCollaboratorsDisplay.innerHTML = '';
                if (project.collaborators && project.collaborators.length > 0) {
                    project.collaborators.forEach(collab => {
                        addCollaboratorChip(collab._id, collab.name, collab.profilePic, true);
                    });
                }
                updateCollaboratorIdsHiddenInput();

                // Call renderDynamicFields with project-specific data
                renderDynamicFields(project.projectDetails || {});
                
            } catch (error) {
                console.error('Error loading project data:', error);
                Toastify({ text: 'Error loading project details: ' + error.message, duration: 3000, style: { background: '#e74c3c' } }).showToast();
                setTimeout(() => window.location.href = '/profile.html', 3000);
            }
        }

        // --- Main Initialization Function and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Global Header Features
            window.loadUserProfileInHeader();
            const notificationButton = document.getElementById('notificationButton');
            if (notificationButton) {
                notificationButton.addEventListener('shown.bs.dropdown', () => { fetchNotifications(); });
                window.deleteNotification = deleteNotification; // Export delete for use in the mapped HTML
            }

            // 2. Initial Data Load
            loadProjectSchemas().then(loadProjectData);
            
            // 3. Main Event Listeners
            projectTypeSelect.addEventListener('change', () => renderDynamicFields({})); 
            
            // Static image upload listener
            imageInput.addEventListener('change', () => {
                validateFileSize(imageInput, 2, 'Project Image');
                if (imageInput.files[0]) {
                    previewImage(imageInput.files[0], imagePreview, imagePreviewContainer, false);
                    currentProjectData.image = ''; // Mark that a new image is pending upload
                }
            });
            setupDropzone(imageDropzone, imageInput);
            
            removeImageBtn.addEventListener('click', () => {
                imageInput.value = ''; 
                previewImage(null, imagePreview, imagePreviewContainer, false);
                currentProjectData.image = 'DELETED'; 
                Toastify({ text: 'Current image will be deleted on save. (Undo by reloading)', duration: 2000, style: { background: "#dc3545" } }).showToast();
            });

            // Collaborator Search Listener
            collaboratorSearchInput.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    const query = collaboratorSearchInput.value.trim();
                    if (query) {
                        window.searchUsers(query, collaboratorSearchResults, addCollaboratorChip, selectedCollaboratorIds);
                    } else {
                        collaboratorSearchResults.style.display = 'none';
                    }
                }, DEBOUNCE_DELAY_SEARCH);
            });
            
            // Submission Listeners
            document.getElementById('saveChangesBtn').addEventListener('click', (e) => { e.preventDefault(); submitProject(currentProjectData.isPublished); });
            
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                Toastify({ text: 'Edit cancelled', duration: 2000, style: { background: '#6c757d' } }).showToast();
                setTimeout(() => window.location.href = '/profile.html', 2000);
            });
        });
    </script>
</body>
</html>